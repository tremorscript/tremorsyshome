<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Azure IoT :: Tremorscript</title>
    <link rel="canonical" href="https://tremorscript.com/studynotes/0.1/azure_iot/overview.html">
    <meta name="generator" content="Antora 3.1.2">
    <link rel="stylesheet" href="../../../_/css/site.css">
    <script>var uiRootPath = '../../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://tremorscript.com">Tremorscript</a>
      <div class="navbar-item search hide-for-print">
        <div id="search-field" class="field">
          <input id="search-input" type="text" placeholder="Search the docs">
        </div>
      </div>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Home</a>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="studynotes" data-version="0.1">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">Study Notes</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../index.html">Study Notes</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../FSharp/overview.html">FSharp Notes</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Computation Expressions</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../FSharp/LogBuilder.html">Log Builder</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../FSharp/MaybeBuilder.html">Maybe Builder</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../FSharp/OrElseBuilder.html">OrElse Builder</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../FSharp/IntroducingBind.html">Introducing Bind</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../FSharp/WrapperTypes.html">Wrapper Types</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../FSharp/WorkflowRulesForWrapperTypes.html">Rules for workflows that use wrapper types</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../FSharp/ComputationExpressionComposition.html">Composition of computation expression</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../FSharp/ListWrapperTypes.html">List Wrapper Types</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../FSharp/IdentityWrapperTypes.html">Identity Wrapper Types</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../FSharp/DoMethod.html">Do Method</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../FSharp/YieldMethod.html">Yield Method</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../FSharp/CombineMethod.html">Combine method</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../FSharp/DelayRunMethod.html">Delay and Run Method</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../Git/overview.html">Git Notes</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../Devops/devopsfordevelopers.html">Devops for Asp.Net Core developers</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="overview.html">Azure IoT</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Study Notes</span>
    <span class="version">0.1</span>
  </div>
  <ul class="components">
    <li class="component">
      <a class="title" href="../../../azurearchitecturestarterpack/1/index.html">Azure Architecture Starter Pack</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../azurearchitecturestarterpack/1/index.html">1-beta.1</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../homesite/1.0.0/index.html">Home page</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../homesite/1.0.0/index.html">1.0.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../projectstarterpack/1.0.0/inline-text-formatting.html">New Project Starter Pack</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../projectstarterpack/1.0.0/inline-text-formatting.html">1.0.0</a>
        </li>
      </ul>
    </li>
    <li class="component is-current">
      <a class="title" href="../index.html">Study Notes</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">0.1</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../../homesite/1.0.0/index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">Study Notes</a></li>
    <li><a href="overview.html">Azure IoT</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/tremorscript/ReferenceGuides/edit/main/docs/modules/azure_iot/pages/overview.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Azure IoT</h1>
<div class="sect1">
<h2 id="_subsystems_of_iot"><a class="anchor" href="#_subsystems_of_iot"></a>Subsystems of IoT</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_core_subsystems"><a class="anchor" href="#_core_subsystems"></a>Core Subsystems</h3>
<div class="paragraph">
<p>An IoT solution architecture consists of the following subsystems:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Devices securely connecting to the cloud.</p>
</li>
<li>
<p>Devices sending and receiving data from the cloud.</p>
</li>
<li>
<p>A cloud gateway service, or hub, that provides device management capabilities.</p>
</li>
<li>
<p>The cloud gateway service, or hub, must securely accept data from the devices.</p>
</li>
<li>
<p>Stream processors consume data from the hub.</p>
</li>
<li>
<p>Stream processors also integrate with business processes.</p>
</li>
<li>
<p>They also place the data into storage.</p>
</li>
<li>
<p>A user interface to visualize telemetry data and facilitate device management.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Below diagram illustrates the core subsystems of IoT</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://learn.microsoft.com/en-us/training/wwl-azure/introduction-iot-solution-architecture/media/m01-l02-core-subsystems-iot-architecture-8158ad9e.png" alt="m01 l02 core subsystems iot architecture 8158ad9e">
</div>
<div class="title">Figure 1. Source: Microsoft Learn, Core Subsystems</div>
</div>
</div>
<div class="sect2">
<h3 id="_optional_subsystems"><a class="anchor" href="#_optional_subsystems"></a>Optional Subsystems</h3>
<div class="paragraph">
<p>Many IoT apps will include subsystems for the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>IoT Edge Devices</strong> to manage access and information flow</p>
</li>
<li>
<p>They may help with device provisioning, data filtering, batching and aggregation, buffering of data, protocol translation, event rules processing etc.</p>
</li>
<li>
<p><strong>Data Transformation Subsystem</strong> for manipulation and aggregation of the telemetry stream either before or after it is received by the cloud gateway service (the IoT hub).</p>
</li>
<li>
<p>Manipulation can include protocol transformation (for example, converting binary data to json) etc.</p>
</li>
<li>
<p><strong>Bulk Device Provisioning</strong> for deploying fleet of devices.</p>
</li>
<li>
<p><strong>User Management Subsystem</strong> for specifying groups and users who can perform action on devices (for example, updating firmware etc).</p>
</li>
<li>
<p><strong>ML Subsystem</strong> to learn from data and experiences and to act without being explicitly programmed.</p>
</li>
<li>
<p>Hot/warm/cold <strong>storage</strong> paths.</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="https://learn.microsoft.com/en-us/training/wwl-azure/introduction-iot-solution-architecture/media/m01-l02-optional-subsystems-iot-architecture-416c18f0.png" alt="m01 l02 optional subsystems iot architecture 416c18f0">
</div>
<div class="title">Figure 2. Source: Micorsoft Learn, Optional Subsystems</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_data_flow_and_processing"><a class="anchor" href="#_data_flow_and_processing"></a>Data flow and processing</h2>
<div class="sectionbody">
<div class="paragraph">
<p>There are four categories of stages (storage, routing, analysis, action/display):</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Storage includes in-memory caches, temp queues and permanent archives(database).</p>
</li>
<li>
<p>Routing makes the decision on what data should go to which target and when. Targets include storage, analysis processes and action.</p>
</li>
<li>
<p>Analyis is used to run the data records through a set of conditions and can produce different output data records.</p>
</li>
<li>
<p>Original data records and post-analysis output data records are stored and available for display and may trigger actions such as sending email, sms etc.</p>
</li>
</ul>
</div>
<h3 id="_data_flow_scenarios" class="discrete">Data flow Scenarios</h3>
<div class="ulist">
<div class="title">Scenario 1</div>
<ul>
<li>
<p>Device sends data to IoT Hub.</p>
</li>
<li>
<p>IoT hub temporarily stores data.</p>
</li>
<li>
<p>This data is immediately displayed as a graph on-screen.</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="https://learn.microsoft.com/en-us/training/wwl-azure/introduction-iot-solution-architecture/media/m01-l02-data-flow-1-b3c3a3af.png" alt="m01 l02 data flow 1 b3c3a3af">
</div>
<div class="title">Figure 3. Source: Microsoft Learn</div>
</div>
<div class="ulist">
<div class="title">Scenario 2</div>
<ul>
<li>
<p>Device sends data to IoT Hub.</p>
</li>
<li>
<p>IoT hub temporarily stores data.</p>
</li>
<li>
<p>The data is then analyzed to detect anomalies, which can then be used to trigger actions such as sending email, text etc.</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="https://learn.microsoft.com/en-us/training/wwl-azure/introduction-iot-solution-architecture/media/m01-l02-data-flow-2-1385659c.png" alt="m01 l02 data flow 2 1385659c">
</div>
<div class="title">Figure 4. Source: Microsoft Learn</div>
</div>
<div class="ulist">
<div class="title">Scenario 3</div>
<ul>
<li>
<p>Some devices may connect directly to the cloud.</p>
</li>
<li>
<p>Some devices may store data on premise within field/edge gateways before sending it to the cloud.</p>
</li>
<li>
<p>Some legacy or constrained devices may use protocol translation provided by an edge gateway.</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="https://learn.microsoft.com/en-us/training/wwl-azure/introduction-iot-solution-architecture/media/m01-l02-data-flow-3-0a8e4444.png" alt="m01 l02 data flow 3 0a8e4444">
</div>
<div class="title">Figure 5. Source: Microsoft Learn</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_cross_cutting_architectural_needs"><a class="anchor" href="#_cross_cutting_architectural_needs"></a>Cross-cutting architectural needs</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Cross-cutting architectural needs:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Security Requirements</p>
</li>
<li>
<p>User Management and Auditing</p>
</li>
<li>
<p>Device Connectivity</p>
</li>
<li>
<p>In-transit Telemetry</p>
</li>
<li>
<p>At-rest Security</p>
</li>
<li>
<p>Logging and Monitoring for individual subsystems and the application</p>
</li>
<li>
<p>High Availability</p>
</li>
<li>
<p>Disaster Recovery</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="https://learn.microsoft.com/en-us/training/wwl-azure/introduction-iot-solution-architecture/media/m01-l02-cross-cutting-needs-subsystems-7d98fb39.png" alt="m01 l02 cross cutting needs subsystems 7d98fb39">
</div>
<div class="title">Figure 6. Source: Microsoft Learn</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_iot_hardware_components"><a class="anchor" href="#_iot_hardware_components"></a>IoT Hardware components</h2>
<div class="sectionbody">
<h3 id="_ip_enabled_iot_devices" class="discrete">IP-enabled IoT devices</h3>
<div class="paragraph">
<p>An IP-enabled device is, simply, a device that can establish a connection to a network and have a unique identity on that network.<br>
IP-enabled devices are deployed in scenarios where data needs to be collected, delivered, and analyzed in real-time, or periodically.</p>
</div>
<h3 id="_non_ip_enabled_devices" class="discrete">Non-IP enabled devices</h3>
<div class="paragraph">
<p>A device does not need to be directly IP-enabled in order to be part of the solution.<br>
They can connect to other devices like a field gateway (IoT Edge device).<br>
These devices can use protocols like CoAP5, OPC or technologies like Bluetooth, ZigBee to connect to other hardware.</p>
</div>
<h3 id="_sensors" class="discrete">Sensors</h3>
<div class="paragraph">
<p>A sensor is a circuit (or device) that collects a specific type of data about the physical environment.<br>
A <strong>smart sensor</strong> is a device that gathers input and processes that information locally before communicating message data.</p>
</div>
<h3 id="_iot_edge_devices_and_field_gateways" class="discrete">IoT Edge devices and field gateways</h3>
<div class="paragraph">
<p>A <strong>field gateway</strong> is a specialized device-appliance or a general-purpose software that:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>acts as a communication enabler.</p>
</li>
<li>
<p>may act as a local device control system and device data processing hub.</p>
</li>
<li>
<p>can perform local processing.</p>
</li>
<li>
<p>can control functions that are directed back towards the child devices that are connected to it.</p>
</li>
<li>
<p>can be used to filter or aggregate device telemetry.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The scope of a field gateway includes the field gateway itself and all devices that are attached to it.</p>
</div>
<div class="paragraph">
<p>Gateways may help with device provisioning, data filtering, batching and aggregation, buffering of data, protocol translation, and event processing rules.</p>
</div>
<div class="paragraph">
<p>NAT devices or firewalls do not qualify as field gateways since they are not explicit connection or session terminals, but rather route (or deny) connections or sessions made through them.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_review_azure_iot_technologies"><a class="anchor" href="#_review_azure_iot_technologies"></a>Review Azure IoT technologies</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_managed_apaas_solutions"><a class="anchor" href="#_managed_apaas_solutions"></a>Managed aPaaS solutions</h3>
<div class="paragraph">
<p>Application platform as a service (aPaas) provides a cloud environment to build, manage, and deliver applications to customers.</p>
</div>
<div class="paragraph">
<p>Azure IoT central is a fully managed, end-to-end ready made environment for IoT solution development.</p>
</div>
<div class="paragraph">
<p>It delivers built-in disaster recovery, multitenancy, global availability, and a predictable cost structure.</p>
</div>
</div>
<div class="sect2">
<h3 id="_flexible_paas_solutions"><a class="anchor" href="#_flexible_paas_solutions"></a>Flexible PaaS solutions</h3>
<div class="paragraph">
<p>You can tailor Azure hardware and software tools to a specific task or job function.<br>
You are responsible for scaling and configuration.<br>
The underlying infrastructure as a service (IaaS) is taken care for you.</p>
</div>
<div class="sect3">
<h4 id="_iot_edge_and_azure_sphere"><a class="anchor" href="#_iot_edge_and_azure_sphere"></a>IoT Edge and Azure Sphere</h4>
<div class="ulist">
<ul>
<li>
<p>Develop your <strong>IoT devices</strong> using one of the <strong>Azure IoT starter kits</strong> or choose a device to use from the <strong>Azure Certified for IoT device</strong> catalog.</p>
</li>
<li>
<p>SDKs are available for multiple programming languages.</p>
</li>
<li>
<p><strong>IoT Plug and Play</strong> can simplify how you create embedded code for your devices.</p>
</li>
<li>
<p><strong>Azure IoT Edge</strong> enables offloading parts of your workload from the cloud to the devices.</p>
</li>
<li>
<p>It can reduce latency, reduce the amount of data exchanged with the cloud, and enable offline scenarios.</p>
</li>
<li>
<p><strong>Azure Sphere</strong> is a secured, high-level app platform with built-in communication and security features for internet connected devices.</p>
</li>
<li>
<p>It includes a secured microcontroller unit, a custom linux-based operating system, and a cloud based security service which provides continuous, renewable security.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_iot_hub"><a class="anchor" href="#_iot_hub"></a>IoT Hub</h4>
<div class="paragraph">
<p><strong>IoT hub</strong> service enables reliable and secure bidirectional communications between millions of IoT devices and a cloud based solution.</p>
</div>
<div class="paragraph">
<p><strong>IoT Hub Device Provision System</strong> is a helper service that provides zero-touch, just-in-time provisioning of devices to the right IoT hub without requiring human intervention.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_azure_digital_twins"><a class="anchor" href="#_azure_digital_twins"></a>Azure Digital Twins</h3>
<div class="paragraph">
<p>IoT Central uses <strong>Azure Digital Twins</strong> to synchronize devices and data in the real world with the digital models that enable users to monitor and manage those connected devices.</p>
</div>
</div>
<div class="sect2">
<h3 id="_azure_stream_azure_data_explorer_and_azure_maps"><a class="anchor" href="#_azure_stream_azure_data_explorer_and_azure_maps"></a>Azure Stream, Azure Data Explorer and Azure Maps</h3>
<div class="paragraph">
<p><strong>Azure Stream Analytics</strong> and <strong>Azure Data Explorer</strong> can be used to process, query, analyze, and visualize data.</p>
</div>
<div class="paragraph">
<p><strong>Azure Maps</strong> is a collection of geospatial services that use fresh mapping data to provide accurate geographic context to web and mobile applications.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_iot_device_software_options"><a class="anchor" href="#_iot_device_software_options"></a>IoT device software options</h2>
<div class="sectionbody">
<div class="paragraph">
<p>IoT devices need to run code to be useful.</p>
</div>
<div class="paragraph">
<p>Device operating system options:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Windows 10 IoT enterprise (Managed)</p>
</li>
<li>
<p>Ubuntu Core (Open source)</p>
</li>
<li>
<p>Riot (Open source)</p>
</li>
<li>
<p>QNX (managed)</p>
</li>
<li>
<p>Android Automative (managed)</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_cloud_service_components_of_an_iot_solution"><a class="anchor" href="#_cloud_service_components_of_an_iot_solution"></a>Cloud service components of an IoT solution</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_cloud_gateways"><a class="anchor" href="#_cloud_gateways"></a>Cloud Gateways</h3>
<div class="paragraph">
<p>A cloud gateway enables you to manage your IoT devices and brokers the communication with other cloud services.</p>
</div>
<div class="paragraph">
<p>Cloud gateways can provide workloads such as:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Authentication and Authorization</p>
</li>
<li>
<p>Message brokering</p>
</li>
<li>
<p>Data storage and filtering</p>
</li>
<li>
<p>Data analytics</p>
</li>
<li>
<p>Functions (discrete code blocks that perform specific tasks)</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="https://learn.microsoft.com/en-us/training/wwl-azure/examine-components-iot-solution/media/m01-l03-cloud-gateway-6a9bb3cb.png" alt="m01 l03 cloud gateway 6a9bb3cb">
</div>
<div class="title">Figure 7. Source Microsoft Learn</div>
</div>
</div>
<div class="sect2">
<h3 id="_data_storage_options"><a class="anchor" href="#_data_storage_options"></a>Data storage options</h3>
<div class="paragraph">
<p>Data is often time-series data. It is common to split data into "warm" and "cold" data stores.<br>
The <strong>warm data</strong> holds recent data that needs to be accessed with low latency.<br>
You can decide the duration range (for example, the last day, week, or month)<br>
Data stored in <strong>cold storage</strong> is historical data.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://learn.microsoft.com/en-us/training/wwl-azure/examine-components-iot-solution/media/m01-l03-warm-cold-storage-68f98297.png" alt="m01 l03 warm cold storage 68f98297">
</div>
<div class="title">Figure 8. Source Microsoft Learn</div>
</div>
</div>
<div class="sect2">
<h3 id="_analytics"><a class="anchor" href="#_analytics"></a>Analytics</h3>
<div class="paragraph">
<p>Without analytics, data collected from IoT would be too voluminous and unstructured to visualize or gain insights.<br>
Analytic services enable architects to build meaningful relationships between sets of data in order to make it easier to manage.</p>
</div>
</div>
<div class="sect2">
<h3 id="_data_visualization"><a class="anchor" href="#_data_visualization"></a>Data visualization</h3>
<div class="paragraph">
<p>Data visualization tools can take input from various data streams and combine them into "dashboards" that can be used to tell a story about the data that was collected.<br>
Ultimately, getting more out of your data is the goal of IoT.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_iot_hub_2"><a class="anchor" href="#_iot_hub_2"></a>IoT Hub</h2>
<div class="sectionbody">
<div class="paragraph">
<p>IoT Hub is a managed service that acts as a central message hub for bi-directional communication between your IoT application and the devices it manages.</p>
</div>
<div class="paragraph">
<p>IoT Hub gives you a secure communication channel for your devices to send data</p>
</div>
<div class="ulist">
<ul>
<li>
<p>per-device authentication enables each device to connect securely to IoT hub and be managed securely by IoT hub.</p>
</li>
<li>
<p>You can control user device access and per-device level connection.</p>
</li>
<li>
<p>IoT Hub Device Provisioning Service automatically provisions devices to the correct IoT Hub when the device first boots up.</p>
</li>
<li>
<p>Multiple authentication types:</p>
<div class="ulist">
<ul>
<li>
<p>SAS token-based authentication.</p>
</li>
<li>
<p>Individual X.509 certificate authentication for secure, standards-based authentication.</p>
</li>
<li>
<p>X.509 CA authentication for simple, standards-based enrollment.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>IoT Hub can scale to millions of devices and can handle millions of events per second.</p>
</div>
<div class="paragraph">
<p>IoT Hub has <strong>built-in routing</strong> and can setup automatic, rules-based message fan-out:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Use message routing to control where your hub sends device telemetry.</p>
</li>
<li>
<p>Can route messages to multiple endpoints at no extra cost.</p>
</li>
<li>
<p>No-code routing rules instead of writing custom message dispatcher code.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>IoT Hub can integrate with other services:-</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Azure Event Grid to help your business to quickly react to critical events.</p>
</li>
<li>
<p>Azure Logic Apps to automate business processes.</p>
</li>
<li>
<p>Azure Machine Learning to add machine learning and AI models.</p>
</li>
<li>
<p>Azure Stream Analytics to run real-time analytic computations on the data.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>IoT Hub can manage your devices:-</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Store, synchronize, and query device metadata and state information for all your devices.</p>
</li>
<li>
<p>Set device state either per-device or based on some common characteristic.</p>
</li>
<li>
<p>Automatically respond to a device-reported state change.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Use Azure IoT device SDK libraries to build applications that run on your devices and interact with IoT Hub.</p>
</div>
<div class="paragraph">
<p>There is a limit of 50 IoT hubs per subscription. You can request quota increases by contacting support.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_device_provisioning_service"><a class="anchor" href="#_device_provisioning_service"></a>Device Provisioning Service</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Provisioning is a two part process:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The first part is establishing the initial connection between the device and the IoT solution by registering the device.</p>
</li>
<li>
<p>The second part is applying the proper configuration to the device based on the requirements of the solution it was registered to.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Features:-</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Secure attestation support for both X.509 and TPM-based identities</p>
</li>
<li>
<p>Multiple allocation policies to control how the DPS assigns devices to IoT hubs.</p>
</li>
<li>
<p>Monitoring and diagnostic logging</p>
</li>
<li>
<p>Mult-hub support allows DPS to assign devices to more than one IoT hub across subscriptions.</p>
</li>
<li>
<p>Cross-region support to assign devices in other regions.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When to use:-</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Zero-touch provisioning to an IoT solution without hardcoding IoT Hub connection.</p>
</li>
<li>
<p>Load-balancing devices across multiple hubs.</p>
</li>
<li>
<p>Connecting devices to a particular IoT solution depending on use case.</p>
</li>
<li>
<p>Connecting a device to the IoT hub with the lowest latency.</p>
</li>
<li>
<p>Reprovisioning based on a change in the device.</p>
</li>
<li>
<p>Rolling the keys used by the device to connect to IoT Hub.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_iot_hub_properties"><a class="anchor" href="#_iot_hub_properties"></a>IoT Hub properties</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_iot_hub_tiers"><a class="anchor" href="#_iot_hub_tiers"></a>IoT Hub Tiers</h3>
<div class="paragraph">
<p>To evaluate which IoT Hub tier is right for you solution, consider the following two questions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>What features do I plan to use?</p>
</li>
<li>
<p>How much data do I plan to move daily?</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_basic_tier"><a class="anchor" href="#_basic_tier"></a>Basic Tier</h4>
<div class="paragraph">
<p>The basic tier enables a subset of features and is intended for IoT solutions that only need uni-directional communication from devices to the cloud.<br>
If your IoT solution is based around collecting data from devices and analyzing it centrally, then the basic tier is probably right for you.</p>
</div>
</div>
<div class="sect3">
<h4 id="_standard_tier"><a class="anchor" href="#_standard_tier"></a>Standard Tier</h4>
<div class="paragraph">
<p>The standard tier of IoT Hubs enables all features, and is required for any IoT solutions that want to make use of the bi-directional communication capabilities.<br>
If you would like to control IoT devices remotely or distribute some of your workloads onto the devices themselves, then you should consider the standard tier.</p>
</div>
</div>
<div class="sect3">
<h4 id="_message_throughtput"><a class="anchor" href="#_message_throughtput"></a>Message throughtput</h4>
<div class="paragraph">
<p>Message traffic is measured for your IoT hub on a per-unit basis.<br>
When you create an IoT hub, you choose its tier and edition, and set the number of units available.<br>
You can purchase up to 200 units for the B1, B2, S1, or S2 edition, or up to 10 units for the B3 or S3 edition.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Tier edition</th>
<th class="tableblock halign-left valign-top">Sustained throughput</th>
<th class="tableblock halign-left valign-top">Sustained send rate</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">B1, S1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Up to 1111 KB/minute per unit (1.5 GB/day/unit)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Average of 278 messages/minute per unit (400,000 messages/day per unit)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">B2, S2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Up to 16 MB/minute per unit (22.8 GB/day/unit)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Average of 4,167 messages/minute per unit (6 million messages/day per unit)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">B3, S3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Up to 814 MB/minute per unit (1144.4 GB/day/unit)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Average of 208,333 messages/minute per unit (300 million messages/day per unit)</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_partitions"><a class="anchor" href="#_partitions"></a>Partitions</h4>
<div class="paragraph">
<p>Partions can be used to reduce contentions that could occur when concurrently reading and writing to event streams.<br>
The partition limit is chosen when IoT hub is created.<br>
The maximum partition limit is 32 but most IoT hubs only need 4 partitions.<br>
The number of partitions is directly related to the number of concurrent readers you expect to have.</p>
</div>
<div class="paragraph">
<p>The default value of four partitions should be used unless specified by the architect.</p>
</div>
</div>
<div class="sect3">
<h4 id="_tier_upgrade"><a class="anchor" href="#_tier_upgrade"></a>Tier upgrade</h4>
<div class="paragraph">
<p>You can upgrade from the basic tier to the standard tier without interrupting your existing operations.
You cannot downgrade to a lower tier. You can move from S2 to S1 but not from S1 to B1 tier.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_iot_hub_endpoints"><a class="anchor" href="#_iot_hub_endpoints"></a>IoT Hub endpoints</h3>
<div class="paragraph">
<p>An endpoint is a service that can retrieve data from other services.<br>
Examples of endpoint types:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Device-facing endpoints</strong> that enables devices to perform operations such as sending device-to-cloud messages and receiving cloud-to-device messages.</p>
</li>
<li>
<p><strong>Service-facing management endpoints</strong> that enable back-end apps to perform operations such as device identity management and device twin management.</p>
</li>
<li>
<p><strong>Service facing built-in endpoints</strong> for reading device-to-cloud messages.</p>
</li>
<li>
<p><strong>Custom endpoints</strong> to receive device-to-cloud messages dispatched by a routing rule.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_built_in_endpoints"><a class="anchor" href="#_built_in_endpoints"></a>Built-in endpoints</h4>
<div class="imageblock">
<div class="content">
<img src="https://learn.microsoft.com/en-us/training/wwl-azure/examine-iot-hub-properties/media/m02-l04-iot-hub-endpoints-413257e2.png" alt="m02 l04 iot hub endpoints 413257e2">
</div>
<div class="title">Figure 9. Source Microsoft Learn</div>
</div>
<div class="paragraph">
<p>The IoT hub endpoints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Resource provider</strong>. It exposes an Azure Resource Manager interface. This interface enables Azure subscription owners to create and delete IoT hubs, and to update IoT hub properties.</p>
</li>
<li>
<p><strong>Device identity management</strong>. A set of HTTPS REST endpoints to manage device identities. Device identities are used for device authentication and access control.</p>
</li>
<li>
<p><strong>Device twin management</strong>. A set of HTTPS REST endpoints to query and update device twins.</p>
</li>
<li>
<p><strong>Jobs management</strong> HTTS REST endpoint to query and manage jobs.</p>
</li>
<li>
<p><strong>Device endpoints</strong>. For each device, a set of endpoints are exposed</p>
<div class="ulist">
<ul>
<li>
<p>Send device-to-cloud messages</p>
</li>
<li>
<p>Receive cloud-to-device messages</p>
</li>
<li>
<p>Initiate file uploads - a device uses this endpoint to receive an Azure storage SAS URI from IoT Hub to upload a file.</p>
</li>
<li>
<p>Retrieve and update device twin properties.</p>
</li>
<li>
<p>Receive direct method requests.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Service endpoints</strong>. Exposes a set of endpoints for your solution back end to communicate with your devices. With one exception, these endpoints are only exposed using the AMQP protocols. The method invocation endpoint is exposed over the HTTPS protocol.</p>
<div class="ulist">
<ul>
<li>
<p>Receive device-to-cloud messages.</p>
</li>
<li>
<p>Send cloud-to-device messages and receive delivery acknowledgements.</p>
</li>
<li>
<p>Receive file notifications.</p>
</li>
<li>
<p>Direct method invocation.</p>
</li>
<li>
<p>Receive operation monitoring events.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_custom_endpoints"><a class="anchor" href="#_custom_endpoints"></a>Custom endpoints</h4>
<div class="paragraph">
<p>These endpoints act as service endpoints and are used as sinks for message routes.<br>
Devices cannot write directly to these custom endpoints.</p>
</div>
<div class="paragraph">
<p>The following services are supported as custom endpoints.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Azure Storage containers</p>
</li>
<li>
<p>Event Hubs</p>
</li>
<li>
<p>Service Bus Queues</p>
</li>
<li>
<p>Service Bus Topics</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_security_concepts"><a class="anchor" href="#_security_concepts"></a>Security Concepts</h2>
<div class="sectionbody">
<div class="paragraph">
<p>There are three different ways for controlling access to IoT Hub:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Azure AD</strong>. It provides identity-based authentication and fine-grained authorization with Azure RBAC. It supports only IoT hub service api&#8217;s.</p>
</li>
<li>
<p><strong>SAS</strong>. It lets you group permissions and grant them to applications using access keys and signed security tokens.</p>
</li>
<li>
<p><strong>Per-device security credentials</strong>. Each IoT Hub contains an identity registry. For each device in this registry, you can configure security credentials that grant DeviceConnect permissions scoped to the device&#8217;s endpoints.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_access_control_and_permissions"><a class="anchor" href="#_access_control_and_permissions"></a>Access Control and Permissions</h3>
<div class="paragraph">
<p>Use shared access policies for IoT hub-level access.<br>
Use the individual device credentials to scope access to that device only.</p>
</div>
</div>
<div class="sect2">
<h3 id="_authentication"><a class="anchor" href="#_authentication"></a>Authentication</h3>
<div class="paragraph">
<p>Azure IoT hub grants access to endpoints by verifying a token against the shared access policies and identity registry security credentials.</p>
</div>
</div>
<div class="sect2">
<h3 id="_security_tokens"><a class="anchor" href="#_security_tokens"></a>Security tokens</h3>
<div class="paragraph">
<p>IoT Hub uses security tokens to authenticate devices and services to avoid sending keys on the wire.<br>
Security tokens are limited in time validity and scope.<br>
Some scenarios do require you to use security tokens directly. Example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The direct use of the MQTT, AMQP, or HTTPS surfaces.</p>
</li>
<li>
<p>The implementation of the token service pattern.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>IoT hub also allows devices to authenticate with IoT Hub using X.509 certificates.</p>
</div>
</div>
<div class="sect2">
<h3 id="_supported_x_509_certificates"><a class="anchor" href="#_supported_x_509_certificates"></a>Supported X.509 certificates</h3>
<div class="paragraph">
<p>You can verify using X.509 certificates by uploading either a certificate thumbprint or a certificate authority(CA) to Azure IoT Hub.<br>
Authentication using certificate thumbprints only verifies that the presented thumbprint matches the configured thumbprint.<br>
Authentication using certificate authority validates the certificate chain.</p>
</div>
<div class="paragraph">
<p>Supported Certificates include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>An existing X.509 certificate. A device may already have a certificate that it can then use to authenticate. Works with either thumbprint or CA authentication.</p>
</li>
<li>
<p>CA-signed X.509 certificate. You can use a Certificate Authority signed certificate. Works with either thumbprint or CA authentication.</p>
</li>
<li>
<p>A self generated and self-signed X.509 certificate. A device manufacturer or in-house deployer can generate these certificates and store the corresponding private key (and certificate) on the device. You can use tools such as OpenSSL and Windows SelfSignedCertificate utility for this purpose. Only works with thumbprint authentication.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A device may either use an X.509 certificate or a security token for authentication, but not both.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_iot_device_lifecycle_terms_and_concepts"><a class="anchor" href="#_iot_device_lifecycle_terms_and_concepts"></a>IoT Device Lifecycle Terms and Concepts</h2>
<div class="sectionbody">
<div class="paragraph">
<p>For Azure IoT, there are five stages within the device lifecycle:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Plan: Enable operators to create a device metadata scheme that enables them to query for, and target a group of devices for bulk management operations. You can use the device twin to store this device metadata in the form of tags and properties.</p>
</li>
<li>
<p>Provision: Securely provision new devices to IoT Hub and enable operators to immediately discover device capabilities.</p>
</li>
<li>
<p>Configure: Facilitate bulk configuration changes and firmware updates to devices while maintaining both health and security.</p>
</li>
<li>
<p>Monitor: Monitor overall device collection health, the status of ongoing operations, and alert operators to issues that might require attention.</p>
</li>
<li>
<p>Retire: Replace or decommission devices after a failure, upgrade cycle, or at the end of the service lifetime.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_device_identity_and_registration"><a class="anchor" href="#_device_identity_and_registration"></a>Device Identity and Registration</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_identity_registry"><a class="anchor" href="#_identity_registry"></a>Identity Registry</h3>
<div class="paragraph">
<p>A device must have an entry in the IoT Hub identity registry before it can connect to an IoT Hub.</p>
</div>
<div class="paragraph">
<p>The deviceID is case-sensitive.</p>
</div>
<div class="paragraph">
<p>The identity registry is a REST-capable collection of device identity resources.</p>
</div>
<div class="paragraph">
<p>IoT Hub creates a set of resources for every device in the identity registry such as the queue that contains in-flight cloud-to-device messages.</p>
</div>
<div class="paragraph">
<p>Use the identity registry when you need to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Provision devices that connect to your IoT hub.</p>
</li>
<li>
<p>Control per-device access to your hub&#8217;s device-facing endpoints.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_module_identity"><a class="anchor" href="#_module_identity"></a>Module Identity</h3>
<div class="paragraph">
<p>You can create module identities under a device identity.</p>
</div>
<div class="paragraph">
<p>Each module identity can be configured with an independent connection to IoT hub.</p>
</div>
<div class="paragraph">
<p>You can seperate access control permissions.</p>
</div>
<div class="paragraph">
<p>You can create up to 20 module identites under a device identity.</p>
</div>
</div>
<div class="sect2">
<h3 id="_identity_registry_operations"><a class="anchor" href="#_identity_registry_operations"></a>Identity registry operations</h3>
<div class="paragraph">
<p>Identity registry exposes the following operations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Create device or module identity</p>
</li>
<li>
<p>Update device or module identity</p>
</li>
<li>
<p>Retreive device or module identity</p>
</li>
<li>
<p>Delete device or module identity</p>
</li>
<li>
<p>List up to 1000 identities</p>
</li>
<li>
<p>Export device identities to Azure blob storage</p>
</li>
<li>
<p>Import device identities from Azure blob storage</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_device_creation"><a class="anchor" href="#_device_creation"></a>Device Creation</h3>
<div class="paragraph">
<p>You need to specify the Device ID and the authentication type when creating a new device.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_device_twins"><a class="anchor" href="#_device_twins"></a>Device Twins</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Device Twins are json documents managed by IoT Hub that store device state information associated with a physical device.<br>
This information includes metadata, configurations, and conditions.<br>
Azure IoT Hub maintains a device twin for each registered device.</p>
</div>
<div class="paragraph">
<p>Device twins are implicity created and deleted when a device identity is created or deleted in IoT Hub.</p>
</div>
<div class="paragraph">
<p>A device twin is a JSON document that includes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Tags. A solution back end can read from and write to. Tags are not visible to device apps.</p>
</li>
<li>
<p>Desired properties. The solution back end can set desired properties, and the device app can read them. The device app can also receive notifications of changes in the desired properties.</p>
</li>
<li>
<p>Reported properties. The device app can set reported properties, and the solution back end can read and query them.</p>
</li>
<li>
<p>Device identity properties. The read-only properties from the corresponding device identity stored in the identity registry</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="https://learn.microsoft.com/en-us/training/wwl-azure/examine-iot-device-lifecycle-concepts/media/m02-l01-device-twin-diagram-03c0f21f.png" alt="m02 l01 device twin diagram 03c0f21f">
</div>
<div class="title">Figure 10. Source Microsoft Learn</div>
</div>
<div class="listingblock">
<div class="title">Sample JSON</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
    "deviceId": "devA",
    "etag": "AAAAAAAAAAc=",
    "status": "enabled",
    "statusReason": "provisioned",
    "statusUpdateTime": "0001-01-01T00:00:00",
    "connectionState": "connected",
    "lastActivityTime": "2015-02-30T16:24:48.789Z",
    "cloudToDeviceMessageCount": 0,
    "authenticationType": "sas",
    "x509Thumbprint": {
        "primaryThumbprint": null,
        "secondaryThumbprint": null
    },
    "version": 2,
    "tags": {
        "$etag": "123",
        "deploymentLocation": {
            "building": "43",
            "floor": "1"
        }
    },
    "properties": {
        "desired": {
            "telemetryConfig": {
                "sendFrequency": "5m"
            },
            "$metadata": {...},
            "$version": 1
        },
        "reported": {
            "telemetryConfig": {
                "sendFrequency": "5m",
                "status": "success"
            },
            "batteryLevel": 55,
            "$metadata": {...},
            "$version": 4
        }
    }
}</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_usage"><a class="anchor" href="#_usage"></a>Usage</h3>
<div class="paragraph">
<p>Use device twins to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Store device-specific metadata in the cloud. For example, the deployment location of a vending machine.</p>
</li>
<li>
<p>Report current state information such as available capabilities and conditions from your device app. For example, a device is connected to your IoT hub over cellular or WiFi.</p>
</li>
<li>
<p>Synchronize the state of long-running workflows between device app and back-end app. For example, when the solution back end specifies the new firmware version to install, and the device app reports the various stages of the update process.</p>
</li>
<li>
<p>Query your device metadata, configuration, or state.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The best way to implement device twins within cloud solutions applications is through the Azure IoT SDKs.</p>
</div>
</div>
<div class="sect2">
<h3 id="_module_identity_and_module_twins"><a class="anchor" href="#_module_identity_and_module_twins"></a>Module identity and module twins</h3>
<div class="paragraph">
<p>Each module identity implicitly generates a module twin.</p>
</div>
<div class="paragraph">
<p>Module twins are JSON documents that store module information including metadata, configurations, and conditions.</p>
</div>
<div class="paragraph">
<p>SDKs enable you to create modules where each one opens an independent connection to IoT Hub.<br>
This helps you to use seperate namespaces for different components on your device.<br>
For example, if your vending machine has 3 different sensors controlled by different departments in your company, you can create a module for each sensor.<br>
This way, each department is only able to create jobs or direct methods for the sensor that they control, avoiding conflicts and user errors.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_device_monitoring"><a class="anchor" href="#_device_monitoring"></a>Device monitoring</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Device monitoring is used to track the overall device collection health, the status of ongoing operations, and to alert operators to issues that might require their attention.<br>
You can program devices to update their device twins and report real-time operating conditions and status of update operations.</p>
</div>
<div class="paragraph">
<p>Device twin desired and reported properties can be used to monitor a target condition, target content, or device metrics.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the target condition defines the scope of device twins to be updated. It is specified as a query on twin tags and/or reported properties.</p>
</li>
<li>
<p>the target content defines the desired properties to be added or updated in the targeted device twins. The content includes a path to the section of desired properties to be changed.</p>
</li>
<li>
<p>The metrics define the summary counts of various configuration states such as Success, In Progress, and Error.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_device_retirements"><a class="anchor" href="#_device_retirements"></a>Device Retirements</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Use the IoT Hub identity registry for securely revoking device identities and credentials.</p>
</div>
<div class="paragraph">
<p>You can disable devices by updating the status property of an identity in the identity registry.</p>
</div>
<div class="paragraph">
<p>The disable feature is not available for modules.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_device_configuration_and_communication_protocols"><a class="anchor" href="#_device_configuration_and_communication_protocols"></a>Device Configuration and Communication Protocols</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_protocols"><a class="anchor" href="#_protocols"></a>Protocols</h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Protocol</th>
<th class="tableblock halign-left valign-top">When you should use this protocol.</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MQTT MQTT over WebSocket</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Use with devices that have their own per-device credentials.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">AMQP AMQP over websocket</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Use on field gateways and cloud gateways to take advantage of connection multiplexing across devices.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">HTTPS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Use for devices that support other protocols.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_ports"><a class="anchor" href="#_ports"></a>Ports</h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Protocol</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Port</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MQTT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">8883</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MQTT over WebSockets</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">443</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">AMQP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5671</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">AMQP over WebSockets</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">443</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">HTTPS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">443</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_devices_and_device_provisioning"><a class="anchor" href="#_devices_and_device_provisioning"></a>Devices and Device Provisioning</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_provisioning_process"><a class="anchor" href="#_provisioning_process"></a>Provisioning Process</h3>
<div class="paragraph">
<p>There are two phases in the provisioning/deployment process for a device:-</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The manufacturing phase in which the device is created and prepared at the factory.</p>
</li>
<li>
<p>The cloud setup phase in which the Device Provisioning Service is configured for automated provisioning.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_manufacturing_process_phase"><a class="anchor" href="#_manufacturing_process_phase"></a>Manufacturing Process phase</h4>
<div class="paragraph">
<p>In this step, the device is programmed with the provisioning service information, enabling it to call the provisioning service to get its connection info/IoT solution assignment when it is switched on.</p>
</div>
<div class="paragraph">
<p>Also, in this step, the manufacturer supplies the device deployer/operator with the identifying key information for the device.<br>
This could be an X.509 certificate or the public portion of a trusted platform module. Supplying that information could be as simple as confirming that all devices have an X.509 certificate generated from a signing certificate provided by the device deployer/operator, or as complicated as extracting the public portion of a trusted platform module (TPM) endorsement key from each TPM device. <br>
These services are offered by many silicon manufacturers today.</p>
</div>
</div>
<div class="sect3">
<h4 id="_cloud_setup_phase"><a class="anchor" href="#_cloud_setup_phase"></a>Cloud setup phase</h4>
<div class="paragraph">
<p>This step is about configuring the cloud for proper automatic provisioning.</p>
</div>
<div class="paragraph">
<p>There are two types of users involved.<br>
A device operator - someone who knows how devices are intially set up.<br>
A solution operator - someonw who knows how devices are to be split among the IoT hubs.</p>
</div>
<div class="paragraph">
<p>A one-time initial setup of the provisioning service must occur.<br>
It is done by the solution operator.</p>
</div>
<div class="paragraph">
<p>The device operator then needs to enroll the device.<br>
The device operator takes the key identifying information from the manufacturer and adds it to the enrollment list.</p>
</div>
</div>
<div class="sect3">
<h4 id="_linked_iot_hubs"><a class="anchor" href="#_linked_iot_hubs"></a>Linked IoT Hubs</h4>
<div class="paragraph">
<p>The Device Provisioning Service can only provision devices to IoT hubs that have been linked to it.</p>
</div>
<div class="paragraph">
<p>Linking an IoT hub to an instance of the DPS gives the service read/write permissions to the IoT hub&#8217;s device registry with the link.</p>
</div>
<div class="paragraph">
<p>A DPS can register a device ID and set the initial configuration in the device twin.</p>
</div>
<div class="paragraph">
<p>Linked IoT hubs may be in any Azure region.</p>
</div>
<div class="paragraph">
<p>You may link hubs in other subscriptions to your provisioning service.</p>
</div>
</div>
<div class="sect3">
<h4 id="_allocation_policy"><a class="anchor" href="#_allocation_policy"></a>Allocation policy</h4>
<div class="paragraph">
<p>The service level setting that determines how DPS assigns devices to an IoT hub.</p>
</div>
<div class="paragraph">
<p>There are there supported policies:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Evenly weighted distribution. The default setting. Linked IoT hubs are equally likely to have devices provisioned to them.</p>
</li>
<li>
<p>Lowest Latency. Devices are provisioned to an IoT hub with the lowest latency.</p>
</li>
<li>
<p>Static Configuration via the enrollment list: specification of the desired IoT hub in the enrollment list takes priority over the service-level allocation policy.</p>
</li>
<li>
<p>Custom (Use Azure Function): A custom allocation policy using custom code in an Azure function.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_enrollment"><a class="anchor" href="#_enrollment"></a>Enrollment</h4>
<div class="paragraph">
<p>An enrollment is the record of devices that may register through autoprovisioning.</p>
</div>
<div class="paragraph">
<p>Two types of enrollments are supported:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Group enrollment: Recommended for a large number of devices that share a desired intial configuration, or for devices all going to the same tenant.</p>
</li>
<li>
<p>Individual enrollment: Recommended for devices that require unique intial configurations, or for devices that can only authenticate using SAS tokens via TPM attestation.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Enrollment record contains information about the device or group of devices:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The attestation mechanism used by the device.</p>
</li>
<li>
<p>The optional intial desired configuration.</p>
</li>
<li>
<p>Desired IoT hub.</p>
</li>
<li>
<p>The desired device ID.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_registration"><a class="anchor" href="#_registration"></a>Registration</h4>
<div class="paragraph">
<p>A registration is the record of a device successfully registering/provisioning to an IoT Hub via the Device Provisioning Service.</p>
</div>
<div class="paragraph">
<p>Registration records are created automatically; they can be deleted, but they cannot be updated.</p>
</div>
</div>
<div class="sect3">
<h4 id="_operations"><a class="anchor" href="#_operations"></a>Operations</h4>
<div class="paragraph">
<p>Operations are the billing unit of the Device Provisioning Service.</p>
</div>
<div class="paragraph">
<p>One operation is the successful completion of one instruction to the service.</p>
</div>
<div class="paragraph">
<p>Operations include device registrations and re-registrations; service-side changes such as adding enrollment list entries, and updating enrollment list entries.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_device_enrollment_concepts"><a class="anchor" href="#_device_enrollment_concepts"></a>Device Enrollment Concepts</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The manufacturer is responsible for encoding the device identity info, and the Device Provisioning Service registration URL.</p>
</div>
<div class="sect2">
<h3 id="_id_scope"><a class="anchor" href="#_id_scope"></a>ID Scope</h3>
<div class="paragraph">
<p>The ID scope is assigned to a DPS when it is created by the user.</p>
</div>
<div class="paragraph">
<p>It is used to uniquely identify the specific provisioning service the device will register through.</p>
</div>
<div class="paragraph">
<p>The ID scope is generated by the service and is immutable, which guarantees uniquess.</p>
</div>
</div>
<div class="sect2">
<h3 id="_registration_id"><a class="anchor" href="#_registration_id"></a>Registration ID</h3>
<div class="paragraph">
<p>The registration ID uniquely identifies a device in the Device Provisioning Service.</p>
</div>
<div class="paragraph">
<p>The registration ID must be unique in the provisioning service ID scope.</p>
</div>
<div class="paragraph">
<p>Each device must have a registration ID.</p>
</div>
<div class="paragraph">
<p>The registration ID is alphanumeric, case insensitive, and may contain special characters including colon, period, underscore, and hyphen.</p>
</div>
<div class="paragraph">
<p>When TPM attestation is used, the registration ID is provided by the TPM itself.</p>
</div>
<div class="paragraph">
<p>When X.509-based attestation is used, the registration ID is provided by the subject name of the certificate.</p>
</div>
</div>
<div class="sect2">
<h3 id="_device_id"><a class="anchor" href="#_device_id"></a>Device ID</h3>
<div class="paragraph">
<p>The device ID is the ID as it appears in IoT Hub.</p>
</div>
<div class="paragraph">
<p>The desired ID may be set in the enrollment entry.</p>
</div>
<div class="paragraph">
<p>Setting the desired ID is only supported in individual enrollments.</p>
</div>
<div class="paragraph">
<p>If no desired device ID is specified in the enrollment list, the registration ID is used as the device ID when registering the device.</p>
</div>
</div>
<div class="sect2">
<h3 id="_attestation_mechanism"><a class="anchor" href="#_attestation_mechanism"></a>Attestation mechanism</h3>
<div class="paragraph">
<p>An attestation mechanism is a method used for confirming a device&#8217;s identity.</p>
</div>
<div class="paragraph">
<p>IoT Hub uses "authentication scheme" for a similar concept in that service.</p>
</div>
<div class="paragraph">
<p>The DPS supports the following forms of attestation:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>X.509 certificates based on the standard X.509 certificate authentication flow.</p>
</li>
<li>
<p>Trusted Platform Module (TPM) based on a nonce challenge, using the TPM standard for keys to present a signed Shared Access Signature (SAS) token. TPM attestation does not require a physical TPM on the device, but the service expects to attest using the endorsement key per the TPM spec.</p>
</li>
<li>
<p>Symmetric Key based on shared access signature (SAS) security tokens, which include a hashed signature and an embedded expiration.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A hardware security module (HSM) is recommended for secure, hardware-based storage of device secrets, and is the most secure form of secret storage.<br>
Both X.509 certificates and SAS tokens can be stored in HSM.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_enrollment_types"><a class="anchor" href="#_enrollment_types"></a>Enrollment Types</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_individual_enrollments"><a class="anchor" href="#_individual_enrollments"></a>Individual Enrollments</h3>
<div class="ulist">
<ul>
<li>
<p>It is an entry for a single device that may register.</p>
</li>
<li>
<p>Individual enrollments may use X.509 certificates or SAS tokens as attestation mechanisms.</p>
</li>
<li>
<p>Individual enrollments may have the desired IoT hub device ID specified.</p>
</li>
<li>
<p>Individual enrollments are recommended for devices with unique initial configurations, or for devices that can only use SAS tokens via TPM or virtual TPM as the attestation mechanism.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_group_enrollments"><a class="anchor" href="#_group_enrollments"></a>Group Enrollments</h3>
<div class="ulist">
<ul>
<li>
<p>An enrollment group is a group of devices that share a specific attestation mechanism.</p>
</li>
<li>
<p>Enrollment groups support both X.509 and symmetric keys.</p>
</li>
<li>
<p>All devices in the X.509 enrollment group present X.509 certificates that have been signed by the same root or intermediate Certificate Authority(CA).</p>
</li>
<li>
<p>Each device in the symmetric key enrollment group present SAS tokens derived from the group symmetric key.</p>
</li>
<li>
<p>The enrollment group name and certificate name must be alphanumeric, lowercase, and may contain hyphens.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_x_509_certificate_attestation"><a class="anchor" href="#_x_509_certificate_attestation"></a>X.509 Certificate Attestation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>X.509 certificates are typically arranged in a certificate chain of trust in which each certificate in the chain is signed by the private key of the next higher certificate, and so on, terminating in a self-signed root certificate.<br>
This arrangement establishes a delegated chain of trust from the root certificate generated by a trusted root certificate authority (CA) down through each intermediate CA to the end-entity "leaf" certificate installed on the device.</p>
</div>
<div class="paragraph">
<p>Often the certificate chain represents some logical or physical heirarchy associated with devices.<br>
For example, a manufacturer may:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Issue a self-signed root CA certificate.</p>
</li>
<li>
<p>Use the root certificate to generate a unique intermediate CA certificate for each factory.</p>
</li>
<li>
<p>Use each factory&#8217;s certificate to generate a unique intermediate CA certificate for each production line in the plant.</p>
</li>
<li>
<p>And finally, use the production line certificate to generate a unique device (end-entity) certificate for each device manufactured on the line.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_root_certificate"><a class="anchor" href="#_root_certificate"></a>Root Certificate</h3>
<div class="ulist">
<ul>
<li>
<p>A root certificate is a self-signed X.509 certificate representing a certificate authority (CA).</p>
</li>
<li>
<p>It is the terminus, or trust anchor, of the certificate chain.</p>
</li>
<li>
<p>Root certificates can be self-issued by an organization or purchased from a root certificate authority.</p>
</li>
<li>
<p>The root certificate can also be referred to as a root CA certificate.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_intermediate_certificate"><a class="anchor" href="#_intermediate_certificate"></a>Intermediate Certificate</h3>
<div class="ulist">
<ul>
<li>
<p>An intermediate certificate is an X.509 certificate, which has been signed by the root certificate (or by another intermediate certificate with the root certificate in its chain).</p>
</li>
<li>
<p>The last intermediate certificate in a chain is used to sign the leaf certificate.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_end_entity_leaf_certificate"><a class="anchor" href="#_end_entity_leaf_certificate"></a>End-entity "leaf" certificate</h3>
<div class="ulist">
<ul>
<li>
<p>The leaf certificate, or end-entity certificate, identifies the certificate holder.</p>
</li>
<li>
<p>It has the root certificate in its certificate chain and zero or more intermediate certificates.</p>
</li>
<li>
<p>The leaf certificate is not used to to sign any other certificates.</p>
</li>
<li>
<p>It uniquely identifies the device to the provisioning service and is sometimes referred to as the device certificate.</p>
</li>
<li>
<p>During authentication, the device uses the private key associated with its certificate to respond to a proof of possession challenge from the service.</p>
</li>
<li>
<p>Leaf certificates used with an Individual enrollment entry have a requirement that the Subject Name must be set to the registration ID of the Individual Enrollment entry.</p>
</li>
<li>
<p>Leaf certificates used with an Enrollment group entry should have the Subject Name set to the desired device ID, which will be shown in the Registration Records for the authenticated device in the enrollment group.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_controlling_device_access_to_the_provisioning_service_with_x_509_certificates"><a class="anchor" href="#_controlling_device_access_to_the_provisioning_service_with_x_509_certificates"></a>Controlling device access to the provisioning service with X.509 certificates</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The provisioning service exposes two types of enrollment entry that you can use to control access for devices that use the X.509 attestation mechanism:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Individual enrollment entries are configured with the device certificate associated with a specific device. These entries control enrollments for specific devices.</p>
</li>
<li>
<p>Enrollment group entries are associated with a specific intermediate or root CA certificate. These entries control enrollments for all devices that have that intermediate or root certificate in their certificate chain.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When a device connects to a provisioning service, if an individual enrollment for the device exists, the provisioning service applies that entry.<br>
If there is no individual enrollment for the device and an enrollment group for the first intermediate certificate in the device&#8217;s certificate chain exists, the service applies that entry, and so on, up the chain to the root. The service applies the first applicable entry such that:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If the first enrollment entry found is enabled, the service provisions the device.</p>
</li>
<li>
<p>If the first enrollment entry found is disabled, the service does not provision the device.</p>
</li>
<li>
<p>If no enrollment entry is found for any of the certificates in the device&#8217;s certificate chain, the service does not provision the device.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This mechanism and the hierarchical structure of certificate chains provides powerful flexibility in how you can control access for both individual devices and groups of devices.</p>
</div>
<div class="paragraph">
<p>For example, imagine five devices with the following certificate:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Device 1: root certificate &#8594; certificate A &#8594; device 1 certificate</p>
</li>
<li>
<p>Device 2: root certificate &#8594; certificate A &#8594; device 2 certificate</p>
</li>
<li>
<p>Device 3: root certificate &#8594; certificate A &#8594; device 3 certificate</p>
</li>
<li>
<p>Device 4: root certificate &#8594; certificate B &#8594; device 4 certificate</p>
</li>
<li>
<p>Device 5: root certificate &#8594; certificate B &#8594; device 5 certificate</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Intially, you can create a single enabled group enrollment entry for the root certificate to enable access for all five devices.<br>
If certificate B later becomes compromised, you can create a disabled enrollment group entry for certificate B to prevent Device 4 and Device 5 from enrolling.<br>
If still later Device 3 becomes compromised, you can create a disabled individual enrollment entry for its certificate.<br>
This revokes access for Device 3, but still allows Device 1 and Device 2 to enroll.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_hardware_security_module"><a class="anchor" href="#_hardware_security_module"></a>Hardware Security Module</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>The hardware security module, or HSM, is used for secure, hardware based storage of device secrets, and is the most secure form of secret storage.<br></p>
</li>
<li>
<p>Both X.509 certificates and SAS tokens can be stored in the HSM.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_trusted_platform_module"><a class="anchor" href="#_trusted_platform_module"></a>Trusted Platform Module</h3>
<div class="ulist">
<ul>
<li>
<p>TPM refers to a standard for securely storing keys used to authenticate the platform.</p>
</li>
<li>
<p>TPM can also refer to the I/O interface used to interact with the modules implementing the standard.</p>
</li>
<li>
<p>TPMs can exist as discrete hardware, integrated hardware, firmware-based, or software-based.</p>
</li>
<li>
<p>Device Provisioning service only supports TPM 2.0</p>
</li>
<li>
<p>TPM attestation is based on a nonce challenge, which uses the endorsement and storage root keys to present a signed Shared Access Signature (SAS) token.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_endorsement_key"><a class="anchor" href="#_endorsement_key"></a>Endorsement key</h3>
<div class="ulist">
<ul>
<li>
<p>The endorsement key is an asymmetric key contained inside the TPM.</p>
</li>
<li>
<p>It is internally generated or injected at manufacture time.</p>
</li>
<li>
<p>It is unique for every TPM.</p>
</li>
<li>
<p>It cannot be changed or removed.</p>
</li>
<li>
<p>The private key portion of the endorsement key is never released outside of the TPM.</p>
</li>
<li>
<p>The public portion of the endorsement key is used to recognize a genuine TPM.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_storage_root_key"><a class="anchor" href="#_storage_root_key"></a>Storage root key</h3>
<div class="ulist">
<ul>
<li>
<p>The storage root key is stored in the TPM.</p>
</li>
<li>
<p>It is used to protect the TPM keys created by applications.</p>
</li>
<li>
<p>These cannot be used without the TPM.</p>
</li>
<li>
<p>The storage root key is generated when you take ownership of the TPM.</p>
</li>
<li>
<p>When you clear the TPM so a new user can take ownership, a new storage root key is generated.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_trusted_platform_module_tpm_attestation"><a class="anchor" href="#_trusted_platform_module_tpm_attestation"></a>Trusted Platform Module (TPM) Attestation</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>TPM attestation uses endorsement key (EK) as the secure root of trust.</p>
</li>
<li>
<p>The EK is unique to the TPM.</p>
</li>
<li>
<p>Changing the EK changes the device into a new one.</p>
</li>
<li>
<p>TPMs have another type of key called the storage root key (SRK).</p>
</li>
<li>
<p>An SRK may be generated by the TPMs owner after taking ownership.</p>
</li>
<li>
<p>Taking ownership is a way of saying "Someone sets a password on the HSM".</p>
</li>
<li>
<p>If a TPM device is sold to a new owner, the new owner can take ownership of the TPM to generate a new SRK.</p>
</li>
<li>
<p>The SRK provides a sandbox for the owner to store their keys and provide access revocability if the device or TPM is sold.</p>
</li>
<li>
<p>Once a device has been setup, it will have both an SRK and an EK available for use.</p>
</li>
<li>
<p>TPM ownership could mean many things, follow the instructions relevant to your system to take ownership.</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="https://learn.microsoft.com/en-us/training/wwl-azure/examine-device-provisioning-service-terms-concepts/media/m03-l01-device-provisioning-service-trusted-platform-module-ownership-2e2f42a8.png" alt="m03 l01 device provisioning service trusted platform module ownership 2e2f42a8">
</div>
<div class="title">Figure 11. Source Microsoft Learn</div>
</div>
<div class="sect2">
<h3 id="_high_level_attestation_process"><a class="anchor" href="#_high_level_attestation_process"></a>High-level Attestation Process</h3>
<div class="ulist">
<ul>
<li>
<p>The public part of the EK is used by the DPS for device enrollment.</p>
</li>
<li>
<p>The device vendor can read the EK_pub and upload it to the provisioning service.</p>
</li>
<li>
<p>The device will be recognized when it connects to the DPS.</p>
</li>
<li>
<p>The DPS does not check the SRK or owner.</p>
</li>
<li>
<p>Clearing the TPM erases customer data and not the EK.</p>
</li>
<li>
<p>The device will still be recognized by the DPS when it connects to provision.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_detailed_attestation_process"><a class="anchor" href="#_detailed_attestation_process"></a>Detailed Attestation Process</h3>
<div class="ulist">
<ul>
<li>
<p>The device connects to the DPS and requests to provision.</p>
</li>
<li>
<p>It provides the service its registration ID, an ID scope, and the EK_pub and SRK_pub from the TPM.</p>
</li>
<li>
<p>The service passes the encrypted nonce back to the device.</p>
</li>
<li>
<p>The device decrypts the encrypted nonce and uses that to sign a SAS token to connect again and finish provisioning.</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="https://learn.microsoft.com/en-us/training/wwl-azure/examine-device-provisioning-service-terms-concepts/media/step-one-request-provisioning-78fb84b8.png" alt="step one request provisioning 78fb84b8">
</div>
<div class="title">Figure 12. Source Microsoft Learn</div>
</div>
</div>
<div class="sect2">
<h3 id="_nonce_challenge"><a class="anchor" href="#_nonce_challenge"></a>Nonce challenge</h3>
<div class="ulist">
<ul>
<li>
<p>The device takes the nonce and uses the private portion of the EK and SRK to decrypt the nonce into the TPM.</p>
</li>
<li>
<p>The order of nonce encryption delegates trust from the EK, which is immutable, to the SRK, which can change if a new owner takes ownership of the TPM.</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="https://learn.microsoft.com/en-us/training/wwl-azure/examine-device-provisioning-service-terms-concepts/media/step-two-nonce-challenge-a87bd4ee.png" alt="step two nonce challenge a87bd4ee">
</div>
<div class="title">Figure 13. Source Microsoft Learn</div>
</div>
</div>
<div class="sect2">
<h3 id="_validate_the_nonce_and_receive_credentials"><a class="anchor" href="#_validate_the_nonce_and_receive_credentials"></a>Validate the nonce and receive credentials</h3>
<div class="ulist">
<ul>
<li>
<p>The device then signs a SAS token using the decrypted nonce.</p>
</li>
<li>
<p>It reestablishes connection to the DPS using the signed SAS token.</p>
</li>
<li>
<p>With the Nonce challenge completed, the service allows the device to provision.</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="https://learn.microsoft.com/en-us/training/wwl-azure/examine-device-provisioning-service-terms-concepts/media/m03-l01-device-provisioning-service-trusted-platform-module-attestation-step-three-validation-922a60fc.png" alt="m03 l01 device provisioning service trusted platform module attestation step three validation 922a60fc">
</div>
<div class="title">Figure 14. Source Microsoft Learn</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_symmetric_key_attestation"><a class="anchor" href="#_symmetric_key_attestation"></a>Symmetric Key Attestation</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Symmetric key attestation is a simple approach to authenticating a device with DPS.</p>
</li>
<li>
<p>Can be used if you do not have strict security requirements.</p>
</li>
<li>
<p>It is useful for legacy devices with limited security functionality.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_symmetric_key_creation"><a class="anchor" href="#_symmetric_key_creation"></a>Symmetric Key Creation</h3>
<div class="ulist">
<ul>
<li>
<p>The DPS creates new symmetric keys with a default length of 32 bytes when new enrollments are saved with the <strong>Auto generate keys</strong> option enabled.</p>
</li>
<li>
<p>You can also specify your own symmetric keys.</p>
</li>
<li>
<p>Your keys must have a key length between 16 bytes and 64 bytes.</p>
</li>
<li>
<p>The keys must be in valid Base64 format.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_sas_tokens"><a class="anchor" href="#_sas_tokens"></a>SAS tokens</h3>
<div class="paragraph">
<p>SAS tokens have the following form:-<br>
<code>SharedAccessSignature sig={signature}&amp;se={expiry}&amp;skn={policyName}&amp;sr={URL-encoded-resourceURI}</code></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Signature is the HMAC-SHA256 signature string produced by using the symmetric key or the enrollment group key. The key must be decoded from base64 before being used to perform the sha256 computation. The signature result must be url encoded.</p>
</li>
<li>
<p>resourceURI is the uri registration endpoint that can be accessed by this token. It starts with the scope ID for the DPS. for example, <code>{scope ID}/registrations/{registration ID}</code></p>
</li>
<li>
<p>expiry is the number of seconds since Jan 1970</p>
</li>
<li>
<p>url-encoded-resourceURI is the lower case URL-encoding of the lower case resource URI.</p>
</li>
<li>
<p>policyName is the name of the shared access policy to which this token refers. The policy name used when provisioning with symmetric key attestation is registration.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_the_device_provisioning_process"><a class="anchor" href="#_the_device_provisioning_process"></a>The Device Provisioning Process</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>The DPS automates many of the manual steps that are traditionally involved in provisioning devices.</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="https://learn.microsoft.com/en-us/training/wwl-azure/examine-device-provisioning-service-terms-concepts/media/m03-l01-device-provisioning-service-provisioning-flow-a8e493e4.png" alt="m03 l01 device provisioning service provisioning flow a8e493e4">
</div>
<div class="title">Figure 15. Source Microsoft Learn</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Device manufacturer adds the device registration information to the enrollment list in the Azure portal</p>
</li>
<li>
<p>Device contacts the DPS set at the factory. The device passes identifying information to the DPS to prove its identity.</p>
</li>
<li>
<p>The DPS validates the identity of the device by validating the registration ID and key against the enrollment list entry using either a nonce challenge (TPM) or X.509 certificates.</p>
</li>
<li>
<p>The DPS registers the device with an IoT Hub and populates the device&#8217;s twin state.</p>
</li>
<li>
<p>The IoT hub returns the deviceID information to the provisioning service.</p>
</li>
<li>
<p>The DPS returns the IoT hub connection information to the device. The device can now start sending data directly to the IoT hub.</p>
</li>
<li>
<p>The device connects to IoT hub.</p>
</li>
<li>
<p>The device gets the desired state from its device twin in IoT hub.</p>
</li>
</ol>
</div>
<div class="sect2">
<h3 id="_autoprovisioning_operation"><a class="anchor" href="#_autoprovisioning_operation"></a>Autoprovisioning Operation</h3>
<div class="imageblock">
<div class="content">
<img src="https://learn.microsoft.com/en-us/training/wwl-azure/examine-device-provisioning-service-terms-concepts/media/m03-l01-auto-provisioning-diagram-aac3c12a.png" alt="m03 l01 auto provisioning diagram aac3c12a">
</div>
<div class="title">Figure 16. Source Microsoft Learn</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Encode identity and registration URL</strong> - the manufacturer is responsible for encoding the device identity info, and the DPS registration URL</p>
</li>
<li>
<p><strong>Provide device identity</strong> the manufacturer is responsible for communicating it to the operator or directly enrolling it to the DPS.</p>
</li>
<li>
<p><strong>Configure autoprovisioning</strong> a one-time configuration of the Azure IoT Hub and IoT Hub Device Provisioning Service instances, establishing them and creating linkage between them.</p>
</li>
<li>
<p><strong>Enroll device identity</strong> Identity is based on the attestation mechanism the device is designed to use, which allows the provisioning service to attest to the device&#8217;s authenticity during registration</p>
</li>
<li>
<p><strong>Build/Deploy registration software.</strong> The Developer is responsible for building and deploying the registration software to the device, using the appropriate SDK.</p>
</li>
<li>
<p><strong>Bootup and register.</strong> initiated upon boot up by registration software, which is built using a Device Provisioning Service client SDK appropriate for the device and attestation mechanism.Upon successful registration, the device is provided with its IoT Hub unique device ID and connection information, allowing it to pull its initial configuration and begin the telemetry process.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_reprovisioning_process"><a class="anchor" href="#_reprovisioning_process"></a>Reprovisioning process</h2>
<div class="sectionbody">

</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script id="site-script" src="../../../_/js/site.js" data-ui-root-path="../../../_"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
<script src="../../../_/js/vendor/lunr.js"></script>
<script src="../../../_/js/search-ui.js" id="search-ui-script" data-site-root-path="../../.." data-snippet-length="100" data-stylesheet="../../../_/css/search.css"></script>
<script async src="../../../search-index.js"></script>
  </body>
</html>

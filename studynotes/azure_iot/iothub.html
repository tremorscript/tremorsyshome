<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Working With IoT Hub :: Tremorscript</title>
    <link rel="canonical" href="https://tremorscript.com/studynotes/azure_iot/iothub.html">
    <meta name="generator" content="Antora 3.1.2">
    <link rel="stylesheet" href="../../_/css/site.css">
    <script>var uiRootPath = '../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://tremorscript.com">Tremorscript</a>
      <div class="navbar-item search hide-for-print">
        <div id="search-field" class="field">
          <input id="search-input" type="text" placeholder="Search the docs">
        </div>
      </div>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Home</a>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="studynotes" data-version="">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">Study Notes</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../index.html">Study Notes</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../FSharp/overview.html">FSharp Notes</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Computation Expressions</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../FSharp/LogBuilder.html">Log Builder</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../FSharp/MaybeBuilder.html">Maybe Builder</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../FSharp/OrElseBuilder.html">OrElse Builder</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../FSharp/IntroducingBind.html">Introducing Bind</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../FSharp/WrapperTypes.html">Wrapper Types</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../FSharp/WorkflowRulesForWrapperTypes.html">Rules for workflows that use wrapper types</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../FSharp/ComputationExpressionComposition.html">Composition of computation expression</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../FSharp/ListWrapperTypes.html">List Wrapper Types</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../FSharp/IdentityWrapperTypes.html">Identity Wrapper Types</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../FSharp/DoMethod.html">Do Method</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../FSharp/YieldMethod.html">Yield Method</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../FSharp/CombineMethod.html">Combine method</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../FSharp/DelayRunMethod.html">Delay and Run Method</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../Git/overview.html">Git Notes</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../Devops/devopsfordevelopers.html">Devops for Asp.Net Core developers</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="overview.html">Azure IoT</a>
<ul class="nav-list">
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="iothub.html">Working With IoT Hub</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="azuredigitaltwins.html">Azure Digital Twins</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../azure_security_engineer/overview.html">Azure Security Engineer</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../CSharp/overview.html">CSharp Notes</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../CSharp/bitwiseoperators.html">Bitwise Operators</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Study Notes</span>
    <span class="version">default</span>
  </div>
  <ul class="components">
    <li class="component">
      <a class="title" href="../../azurearchitecturestarterpack/current/index.html">Azure Architecture Starter Pack</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../azurearchitecturestarterpack/current/index.html">1-beta.1</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../homesite/current/index.html">Home page</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../homesite/current/index.html">1.0.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../projectstarterpack/current/inline-text-formatting.html">New Project Starter Pack</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../projectstarterpack/current/inline-text-formatting.html">1.0.0</a>
        </li>
      </ul>
    </li>
    <li class="component is-current">
      <a class="title" href="../index.html">Study Notes</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">default</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../homesite/current/index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">Study Notes</a></li>
    <li><a href="overview.html">Azure IoT</a></li>
    <li><a href="iothub.html">Working With IoT Hub</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/tremorscript/ReferenceGuides/edit/main/docs/modules/azure_iot/pages/iothub.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Working With IoT Hub</h1>
<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_features">Features</a>
<ul class="sectlevel2">
<li><a href="#_security">Security</a></li>
<li><a href="#_routing">Routing</a></li>
<li><a href="#_integration">Integration</a></li>
<li><a href="#_device_management">Device Management</a></li>
<li><a href="#_developer">Developer</a></li>
</ul>
</li>
<li><a href="#_device_provisioning_service">Device Provisioning Service</a>
<ul class="sectlevel2">
<li><a href="#_provisioning_process">Provisioning Process</a></li>
<li><a href="#_features_2">Features</a></li>
<li><a href="#_when_to_use">When to use</a></li>
</ul>
</li>
<li><a href="#_iot_hub_tiers">IoT Hub Tiers</a>
<ul class="sectlevel2">
<li><a href="#_basic_tier">Basic Tier</a></li>
<li><a href="#_standard_tier">Standard Tier</a></li>
</ul>
</li>
<li><a href="#_iot_hub_message_throughtput">IoT Hub Message Throughtput</a></li>
<li><a href="#_iot_hub_partition">IoT Hub Partition</a></li>
<li><a href="#_iot_hub_endpoint">IoT Hub Endpoint</a>
<ul class="sectlevel2">
<li><a href="#_built_in_endpoints">Built-in endpoints</a></li>
<li><a href="#_custom_endpoints">Custom endpoints</a></li>
</ul>
</li>
<li><a href="#_iot_hub_security">IoT Hub Security</a>
<ul class="sectlevel2">
<li><a href="#_access_control_and_permissions">Access Control and Permissions</a></li>
<li><a href="#_authentication">Authentication</a></li>
<li><a href="#_security_tokens">Security tokens</a></li>
<li><a href="#_supported_x_509_certificates">Supported X.509 certificates</a></li>
</ul>
</li>
<li><a href="#_iot_hub_device_lifecycle_terms_and_concepts">IoT Hub Device Lifecycle Terms and Concepts</a></li>
<li><a href="#_iot_hub_device_identity_and_registration">IoT Hub Device Identity and Registration</a>
<ul class="sectlevel2">
<li><a href="#_identity_registry">Identity Registry</a></li>
<li><a href="#_module_identity">Module Identity</a></li>
<li><a href="#_identity_registry_operations">Identity registry operations</a></li>
<li><a href="#_device_creation">Device Creation</a></li>
</ul>
</li>
<li><a href="#_iot_hub_device_twins_concept">IoT Hub Device Twins Concept</a>
<ul class="sectlevel2">
<li><a href="#_device_twins_usage">Device Twins Usage</a></li>
</ul>
</li>
<li><a href="#_iot_hub_module_identity_and_module_twins">IoT Hub Module Identity and Module Twins</a></li>
<li><a href="#_iot_hub_device_monitoring">IoT Hub Device Monitoring</a></li>
<li><a href="#_iot_hub_device_retirements">IoT Hub Device Retirements</a></li>
<li><a href="#_iot_device_configuration_and_communication_protocols">IoT Device Configuration and Communication Protocols</a>
<ul class="sectlevel2">
<li><a href="#_protocols">Protocols</a></li>
<li><a href="#_ports">Ports</a></li>
</ul>
</li>
<li><a href="#_iot_devices_and_device_provisioning">IoT Devices and Device Provisioning</a>
<ul class="sectlevel2">
<li><a href="#_provisioning_process_2">Provisioning Process</a></li>
</ul>
</li>
<li><a href="#_iot_device_enrollment_concepts">IoT Device Enrollment Concepts</a>
<ul class="sectlevel2">
<li><a href="#_id_scope">ID Scope</a></li>
<li><a href="#_registration_id">Registration ID</a></li>
<li><a href="#_device_id">Device ID</a></li>
<li><a href="#_attestation_mechanism">Attestation mechanism</a></li>
</ul>
</li>
<li><a href="#_iot_device_enrollment_types">IoT Device Enrollment Types</a>
<ul class="sectlevel2">
<li><a href="#_individual_enrollments">Individual Enrollments</a></li>
<li><a href="#_group_enrollments">Group Enrollments</a></li>
</ul>
</li>
<li><a href="#_iot_device_x_509_certificate_attestation_process">IoT Device X.509 Certificate Attestation Process</a>
<ul class="sectlevel2">
<li><a href="#_root_certificate">Root Certificate</a></li>
<li><a href="#_intermediate_certificate">Intermediate Certificate</a></li>
<li><a href="#_end_entity_leaf_certificate">End-entity "leaf" certificate</a></li>
</ul>
</li>
<li><a href="#_controlling_device_access_to_the_provisioning_service_with_x_509_certificates">Controlling device access to the provisioning service with X.509 certificates</a>
<ul class="sectlevel2">
<li><a href="#_process">Process</a></li>
</ul>
</li>
<li><a href="#_iot_device_hardware_security_module">IoT Device Hardware Security Module</a>
<ul class="sectlevel2">
<li><a href="#_trusted_platform_module">Trusted Platform Module</a></li>
<li><a href="#_endorsement_key">Endorsement key</a></li>
<li><a href="#_storage_root_key">Storage root key</a></li>
</ul>
</li>
<li><a href="#_iot_device_trusted_platform_module_tpm_attestation_process">IoT Device Trusted Platform Module (TPM) Attestation Process</a>
<ul class="sectlevel2">
<li><a href="#_high_level_attestation_process">High-level Attestation Process</a></li>
<li><a href="#_detailed_attestation_process">Detailed Attestation Process</a></li>
<li><a href="#_nonce_challenge">Nonce challenge</a></li>
<li><a href="#_validate_the_nonce_and_receive_credentials">Validate the nonce and receive credentials</a></li>
</ul>
</li>
<li><a href="#_iot_device_symmetric_key_attestation">IoT Device Symmetric Key Attestation</a>
<ul class="sectlevel2">
<li><a href="#_symmetric_key_creation">Symmetric Key Creation</a></li>
<li><a href="#_sas_tokens">SAS tokens</a></li>
</ul>
</li>
<li><a href="#_iot_device_provisioning_process">IoT Device Provisioning Process</a></li>
<li><a href="#_iot_device_autoprovisioning_operation">IoT Device Autoprovisioning Operation</a></li>
<li><a href="#_iot_device_reprovisioning_process">IoT Device Reprovisioning Process</a>
<ul class="sectlevel2">
<li><a href="#_reprovisioning_scenarios">Reprovisioning Scenarios</a></li>
<li><a href="#_device_state_data">Device State Data</a></li>
<li><a href="#_reprovisioning_policies">Reprovisioning policies</a></li>
</ul>
</li>
<li><a href="#_iot_device_provisioning_service_azure_cli_commands">IoT Device Provisioning Service Azure CLI Commands</a>
<ul class="sectlevel2">
<li><a href="#_dps_service_commands">DPS Service Commands</a></li>
<li><a href="#_access_policy_commands">Access Policy Commands</a></li>
<li><a href="#_certificate_commands">Certificate Commands</a></li>
<li><a href="#_linked_hub_commands">Linked Hub Commands</a></li>
</ul>
</li>
<li><a href="#_iot_device_provisioning_sdk">IoT Device Provisioning SDK</a>
<ul class="sectlevel2">
<li><a href="#_provisioning_device_sdk">Provisioning Device SDK</a></li>
<li><a href="#_provisioning_service_sdk">Provisioning Service SDK</a></li>
</ul>
</li>
<li><a href="#_iot_device_trusted_platform_module_tpm_simulator">IoT Device Trusted Platform Module (TPM) Simulator</a></li>
<li><a href="#_iot_device_x_509_certificate_generator">IoT Device X.509 certificate Generator</a></li>
<li><a href="#_iot_device_access_control_to_dps">IoT Device Access control to DPS</a>
<ul class="sectlevel2">
<li><a href="#_authentication_2">Authentication</a></li>
<li><a href="#_security_tokens_2">Security tokens</a></li>
<li><a href="#_security_token_structure">Security Token Structure</a></li>
<li><a href="#_use_security_tokens_from_service_components">Use security tokens from service components</a></li>
<li><a href="#_iot_device_provisioning_service">IoT Device Provisioning Service</a></li>
</ul>
</li>
<li><a href="#_iot_device_configure_verified_ca_certificates">IoT Device Configure Verified CA Certificates</a>
<ul class="sectlevel2">
<li><a href="#_proof_of_possession_process">Proof-of-Possession Process</a></li>
<li><a href="#_register_and_get_the_verification_code">Register and get the verification code</a></li>
<li><a href="#_digitally_sign_the_verification_code_to_create_a_verification_certificate">Digitally sign the verification code to create a verification certificate</a></li>
<li><a href="#_upload_the_signed_verification_certificate">Upload the signed verification certificate</a></li>
</ul>
</li>
<li><a href="#_iot_device_roll_certificates">IoT Device - Roll Certificates</a>
<ul class="sectlevel2">
<li><a href="#_roll_the_certificate_on_the_device">Roll the certificate on the device</a></li>
</ul>
</li>
<li><a href="#_iot_device_the_deprovisioning_process">IoT Device - The Deprovisioning process</a></li>
<li><a href="#_iot_device_manage_disenrollment">IoT Device - Manage Disenrollment</a>
<ul class="sectlevel2">
<li><a href="#_blocklist_devices_by_using_an_individual_enrollment_entry">Blocklist devices by using an individual enrollment entry</a></li>
<li><a href="#_blocklist_an_x_509_intermediate_or_root_ca_certificate_by_using_an_enrollment_group">Blocklist an X.509 intermediate or root CA certificate by using an enrollment group.</a></li>
<li><a href="#_blocklist_specific_devices_in_an_enrollment_group">Blocklist specific devices in an enrollment group</a></li>
</ul>
</li>
<li><a href="#_iot_hub_how_to_provision_for_multitenancy">IoT Hub - How to provision for multitenancy</a></li>
<li><a href="#_iot_hub_common_message_format">IoT Hub - Common Message Format</a>
<ul class="sectlevel2">
<li><a href="#_system_properties_of_d2c_iot_hub_messages">System properties of D2C IoT hub messages</a></li>
<li><a href="#_system_properties_of_c2d_iot_hub_messages">System Properties of C2D IoT hub messages</a></li>
<li><a href="#_message_size">Message size</a></li>
<li><a href="#_anti_spoofing_properties">Anti-spoofing properties</a></li>
</ul>
</li>
<li><a href="#_iot_hub_message_routing">IoT Hub - Message Routing</a>
<ul class="sectlevel2">
<li><a href="#_routing_endpoints">Routing endpoints</a></li>
<li><a href="#_routing_queries">Routing queries</a></li>
<li><a href="#_iot_hub_built_in_endpoint">IoT Hub built-in endpoint</a></li>
<li><a href="#_reading_from_the_built_in_endpoint">Reading from the Built-in endpoint</a></li>
<li><a href="#_routing_to_multiple_endpoints">Routing to multiple endpoints</a></li>
<li><a href="#_custom_endpoint">Custom endpoint</a></li>
<li><a href="#_fallback_route">Fallback route</a></li>
<li><a href="#_non_telemetry_events">Non-telemetry events</a></li>
<li><a href="#_latency">Latency</a></li>
<li><a href="#_iot_hub_monitoring_and_troubleshooting">IoT Hub - Monitoring and Troubleshooting</a></li>
</ul>
</li>
<li><a href="#_iot_hub_message_routing_query_syntax">IoT Hub - Message Routing Query Syntax</a>
<ul class="sectlevel2">
<li><a href="#_message_properties_based_routing">Message properties based routing</a></li>
<li><a href="#_message_body_based_routing">Message body based routing</a></li>
<li><a href="#_device_twin_based_routing">Device Twin based routing</a></li>
</ul>
</li>
<li><a href="#_iot_device_message_processing_options_and_constraints">IoT Device Message processing options and constraints</a>
<ul class="sectlevel2">
<li><a href="#_message_enrichments">Message Enrichments</a></li>
</ul>
</li>
<li><a href="#_iot_hub_quotas_and_throttling">IoT Hub quotas and throttling</a></li>
</ul>
</div>
<div class="sect1">
<h2 id="_features"><a class="anchor" href="#_features"></a>Features</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_security"><a class="anchor" href="#_security"></a>Security</h3>
<div class="paragraph">
<p>IoT Hub is a managed service that acts as a central message hub for <strong>bi-directional communication</strong> between your IoT application and the devices it manages.</p>
</div>
<div class="paragraph">
<p>Per-device authentication enables each device to connect securely to IoT hub and be managed securely by IoT hub.</p>
</div>
<div class="paragraph">
<p>You can control user device access and per-device level connection.</p>
</div>
<div class="paragraph">
<p>IoT Hub Device Provisioning Service automatically provisions devices to the correct IoT Hub when the device first boots up.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Multiple authentication types:</p>
<div class="ulist">
<ul>
<li>
<p>SAS token-based authentication.</p>
</li>
<li>
<p>Individual X.509 certificate authentication for secure, standards-based authentication.</p>
</li>
<li>
<p>X.509 CA authentication for simple, standards-based enrollment.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_routing"><a class="anchor" href="#_routing"></a>Routing</h3>
<div class="ulist">
<ul>
<li>
<p>IoT Hub has <strong>built-in routing</strong> and can setup automatic, rules-based message fan-out:</p>
<div class="ulist">
<ul>
<li>
<p>Use message routing to control where your hub sends device telemetry.</p>
</li>
<li>
<p>Can route messages to multiple endpoints at no extra cost.</p>
</li>
<li>
<p>No-code routing rules instead of writing custom message dispatcher code.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_integration"><a class="anchor" href="#_integration"></a>Integration</h3>
<div class="ulist">
<ul>
<li>
<p>IoT Hub can integrate with other services:-</p>
<div class="ulist">
<ul>
<li>
<p>Azure Event Grid to help your business to quickly react to critical events.</p>
</li>
<li>
<p>Azure Logic Apps to automate business processes.</p>
</li>
<li>
<p>Azure Machine Learning to add machine learning and AI models.</p>
</li>
<li>
<p>Azure Stream Analytics to run real-time analytic computations on the data.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_device_management"><a class="anchor" href="#_device_management"></a>Device Management</h3>
<div class="ulist">
<ul>
<li>
<p>IoT Hub can manage your devices:-</p>
<div class="ulist">
<ul>
<li>
<p>Store, synchronize, and query device metadata and state information for all your devices.</p>
</li>
<li>
<p>Set device state either per-device or based on some common characteristic.</p>
</li>
<li>
<p>Automatically respond to a device-reported state change.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_developer"><a class="anchor" href="#_developer"></a>Developer</h3>
<div class="ulist">
<ul>
<li>
<p>Use Azure IoT device SDK libraries to build applications that run on your devices and interact with IoT Hub.</p>
</li>
<li>
<p>There is a limit of 50 IoT hubs per subscription. You can request quota increases by contacting support.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_device_provisioning_service"><a class="anchor" href="#_device_provisioning_service"></a>Device Provisioning Service</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_provisioning_process"><a class="anchor" href="#_provisioning_process"></a>Provisioning Process</h3>
<div class="ulist">
<ul>
<li>
<p>Provisioning is a two part process:</p>
<div class="ulist">
<ul>
<li>
<p>The first part is establishing the initial connection between the device and the IoT solution by registering the device.</p>
</li>
<li>
<p>The second part is applying the proper configuration to the device based on the requirements of the solution it was registered to.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_features_2"><a class="anchor" href="#_features_2"></a>Features</h3>
<div class="ulist">
<ul>
<li>
<p>Secure attestation support for both X.509 and TPM-based identities</p>
</li>
<li>
<p>Multiple allocation policies to control how the DPS assigns devices to IoT hubs.</p>
</li>
<li>
<p>Monitoring and diagnostic logging</p>
</li>
<li>
<p>Mult-hub support allows DPS to assign devices to more than one IoT hub across subscriptions.</p>
</li>
<li>
<p>Cross-region support to assign devices in other regions.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_when_to_use"><a class="anchor" href="#_when_to_use"></a>When to use</h3>
<div class="ulist">
<ul>
<li>
<p>Zero-touch provisioning to an IoT solution without hardcoding IoT Hub connection.</p>
</li>
<li>
<p>Load-balancing devices across multiple hubs.</p>
</li>
<li>
<p>Connecting devices to a particular IoT solution depending on use case.</p>
</li>
<li>
<p>Connecting a device to the IoT hub with the lowest latency.</p>
</li>
<li>
<p>Reprovisioning based on a change in the device.</p>
</li>
<li>
<p>Rolling the keys used by the device to connect to IoT Hub.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_iot_hub_tiers"><a class="anchor" href="#_iot_hub_tiers"></a>IoT Hub Tiers</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>To evaluate which IoT Hub tier is right for you solution, consider the following two questions:</p>
<div class="ulist">
<ul>
<li>
<p>What features do I plan to use?</p>
</li>
<li>
<p>How much data do I plan to move daily?</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_basic_tier"><a class="anchor" href="#_basic_tier"></a>Basic Tier</h3>
<div class="ulist">
<ul>
<li>
<p>This tier enables features for solutions that only need uni-directional communication from devices to the cloud.</p>
</li>
<li>
<p>If your IoT solution is based around collecting data from devices and analyzing it centrally, then the basic tier is probably right for you.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_standard_tier"><a class="anchor" href="#_standard_tier"></a>Standard Tier</h3>
<div class="ulist">
<ul>
<li>
<p>This tier of IoT Hubs enables features for solutions that want to make use of the bi-directional communication capabilities.</p>
</li>
<li>
<p>If you would like to control IoT devices remotely or distribute some of your workloads onto the devices themselves, then you should consider the standard tier.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_iot_hub_message_throughtput"><a class="anchor" href="#_iot_hub_message_throughtput"></a>IoT Hub Message Throughtput</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Message traffic is measured for your IoT hub on a per-unit basis.</p>
</li>
<li>
<p>When you create an IoT hub, you choose its tier and edition, and set the number of units available.</p>
</li>
<li>
<p>You can purchase up to 200 units for the B1, B2, S1, or S2 edition, or up to 10 units for the B3 or S3 edition.</p>
</li>
</ul>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Tier edition</th>
<th class="tableblock halign-left valign-top">Sustained throughput</th>
<th class="tableblock halign-left valign-top">Sustained send rate</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">B1, S1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Up to 1111 KB/minute per unit (1.5 GB/day/unit)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Average of 278 messages/minute per unit (400,000 messages/day per unit)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">B2, S2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Up to 16 MB/minute per unit (22.8 GB/day/unit)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Average of 4,167 messages/minute per unit (6 million messages/day per unit)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">B3, S3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Up to 814 MB/minute per unit (1144.4 GB/day/unit)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Average of 208,333 messages/minute per unit (300 million messages/day per unit)</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect1">
<h2 id="_iot_hub_partition"><a class="anchor" href="#_iot_hub_partition"></a>IoT Hub Partition</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Partions can be used to reduce contentions that could occur when concurrently reading and writing to event streams.</p>
</li>
<li>
<p>The partition limit is chosen when IoT hub is created.</p>
</li>
<li>
<p>The maximum partition limit is 32 but most IoT hubs only need 4 partitions.</p>
</li>
<li>
<p>The number of partitions is directly related to the number of concurrent readers you expect to have.</p>
</li>
<li>
<p>The default value of four partitions should be used unless specified by the architect.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_iot_hub_endpoint"><a class="anchor" href="#_iot_hub_endpoint"></a>IoT Hub Endpoint</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>An endpoint is a service that can retrieve data from other services.</p>
</li>
<li>
<p>Examples of endpoint types:</p>
<div class="ulist">
<ul>
<li>
<p><strong>Device-facing endpoints</strong> that enables devices to perform operations such as sending device-to-cloud messages and receiving cloud-to-device messages.</p>
</li>
<li>
<p><strong>Service-facing management endpoints</strong> that enable back-end apps to perform operations such as device identity management and device twin management.</p>
</li>
<li>
<p><strong>Service facing built-in endpoints</strong> for reading device-to-cloud messages.</p>
</li>
<li>
<p><strong>Custom endpoints</strong> to receive device-to-cloud messages dispatched by a routing rule.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_built_in_endpoints"><a class="anchor" href="#_built_in_endpoints"></a>Built-in endpoints</h3>
<div class="imageblock">
<div class="content">
<img src="https://learn.microsoft.com/en-us/training/wwl-azure/examine-iot-hub-properties/media/m02-l04-iot-hub-endpoints-413257e2.png" alt="m02 l04 iot hub endpoints 413257e2">
</div>
<div class="title">Figure 1. Source Microsoft Learn</div>
</div>
<div class="paragraph">
<p>The IoT hub endpoints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Resource provider</strong>. It exposes an Azure Resource Manager interface. This interface enables Azure subscription owners to create and delete IoT hubs, and to update IoT hub properties.</p>
</li>
<li>
<p><strong>Device identity management</strong>. A set of Https REST endpoints to manage device identities. Device identities are used for device authentication and access control.</p>
</li>
<li>
<p><strong>Device twin management</strong>. A set of Https REST endpoints to query and update device twins.</p>
</li>
<li>
<p><strong>Jobs management</strong>. Https REST endpoint to query and manage jobs.</p>
</li>
<li>
<p><strong>Device endpoints</strong>. For each device, a set of endpoints are exposed</p>
<div class="ulist">
<ul>
<li>
<p>Send device-to-cloud messages.</p>
</li>
<li>
<p>Receive cloud-to-device messages.</p>
</li>
<li>
<p>Initiate file uploads - a device uses this endpoint to receive an Azure storage SAS URI from IoT Hub to upload a file.</p>
</li>
<li>
<p>Retrieve and update device twin properties.</p>
</li>
<li>
<p>Receive direct method requests.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Service endpoints</strong>. Exposes a set of endpoints for your solution back end to communicate with your devices. With one exception, these endpoints are only exposed using the AMQP protocols. The method invocation endpoint is exposed over the Https protocol.</p>
<div class="ulist">
<ul>
<li>
<p>Receive device-to-cloud messages.</p>
</li>
<li>
<p>Send cloud-to-device messages and receive delivery acknowledgements.</p>
</li>
<li>
<p>Receive file notifications.</p>
</li>
<li>
<p>Direct method invocation.</p>
</li>
<li>
<p>Receive operation monitoring events.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_custom_endpoints"><a class="anchor" href="#_custom_endpoints"></a>Custom endpoints</h3>
<div class="ulist">
<ul>
<li>
<p>These endpoints act as service endpoints and are used as sinks for message routes.</p>
</li>
<li>
<p>Devices cannot write directly to these custom endpoints.</p>
</li>
<li>
<p>The following services are supported as custom endpoints.</p>
<div class="ulist">
<ul>
<li>
<p>Azure Storage containers</p>
</li>
<li>
<p>Event Hubs</p>
</li>
<li>
<p>Service Bus Queues</p>
</li>
<li>
<p>Service Bus Topics</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_iot_hub_security"><a class="anchor" href="#_iot_hub_security"></a>IoT Hub Security</h2>
<div class="sectionbody">
<div class="paragraph">
<p>There are three different ways for controlling access to IoT Hub:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Azure AD</strong> - It provides identity-based authentication and fine-grained authorization with Azure RBAC. It supports only IoT hub service api&#8217;s.</p>
</li>
<li>
<p><strong>SAS</strong> - It lets you group permissions and grant them to applications using access keys and signed security tokens.</p>
</li>
<li>
<p><strong>Per-device security credentials</strong> - Each IoT Hub contains an identity registry. For each device in this registry, you can configure security credentials that grant DeviceConnect permissions scoped to the device&#8217;s endpoints.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_access_control_and_permissions"><a class="anchor" href="#_access_control_and_permissions"></a>Access Control and Permissions</h3>
<div class="ulist">
<ul>
<li>
<p>Use shared access policies for IoT hub-level access.</p>
</li>
<li>
<p>Use the individual device credentials to scope access to that device only.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_authentication"><a class="anchor" href="#_authentication"></a>Authentication</h3>
<div class="ulist">
<ul>
<li>
<p>Azure IoT hub grants access to endpoints by verifying a token against the shared access policies and identity registry security credentials.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_security_tokens"><a class="anchor" href="#_security_tokens"></a>Security tokens</h3>
<div class="ulist">
<ul>
<li>
<p>IoT Hub uses security tokens to authenticate devices and services to avoid sending keys on the wire.</p>
</li>
<li>
<p>Security tokens are limited in time validity and scope.</p>
</li>
<li>
<p>Some scenarios do require you to use security tokens directly. Example:</p>
<div class="ulist">
<ul>
<li>
<p>The direct use of the MQTT, AMQP, or HTTPS surfaces.</p>
</li>
<li>
<p>The implementation of the token service pattern.</p>
</li>
</ul>
</div>
</li>
<li>
<p>IoT hub also allows devices to authenticate with IoT Hub using X.509 certificates.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_supported_x_509_certificates"><a class="anchor" href="#_supported_x_509_certificates"></a>Supported X.509 certificates</h3>
<div class="ulist">
<ul>
<li>
<p>You can verify using X.509 certificates by uploading either a certificate thumbprint or a certificate authority (CA) to Azure IoT Hub.</p>
</li>
<li>
<p>Authentication using certificate thumbprints only verifies that the presented thumbprint matches the configured thumbprint.</p>
</li>
<li>
<p>Authentication using certificate authority validates the certificate chain.</p>
</li>
<li>
<p>Supported Certificates include:</p>
<div class="ulist">
<ul>
<li>
<p><strong>An existing X.509 certificate</strong>. A device may already have a certificate that it can then use to authenticate. Works with either thumbprint or CA authentication.</p>
</li>
<li>
<p><strong>CA-signed X.509 certificate</strong>. You can use a Certificate Authority signed certificate. Works with either thumbprint or CA authentication.</p>
</li>
<li>
<p><strong>A self generated and self-signed X.509 certificate</strong>. A device manufacturer or in-house deployer can generate these certificates and store the corresponding private key (and certificate) on the device. You can use tools such as OpenSSL and Windows SelfSignedCertificate utility for this purpose. Only works with thumbprint authentication.</p>
</li>
</ul>
</div>
</li>
<li>
<p>A device may either use an X.509 certificate or a security token for authentication, but not both.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_iot_hub_device_lifecycle_terms_and_concepts"><a class="anchor" href="#_iot_hub_device_lifecycle_terms_and_concepts"></a>IoT Hub Device Lifecycle Terms and Concepts</h2>
<div class="sectionbody">
<div class="paragraph">
<p>For Azure IoT, there are five stages within the device lifecycle:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Plan</strong>: Enable operators to create a device metadata scheme that enables them to query for, and target a group of devices for bulk management operations. You can use the device twin to store this device metadata in the form of tags and properties.</p>
</li>
<li>
<p><strong>Provision</strong>: Securely provision new devices to IoT Hub and enable operators to immediately discover device capabilities.</p>
</li>
<li>
<p><strong>Configure</strong>: Facilitate bulk configuration changes and firmware updates to devices while maintaining both health and security.</p>
</li>
<li>
<p><strong>Monitor</strong>: Monitor overall device collection health, the status of ongoing operations, and alert operators to issues that might require attention.</p>
</li>
<li>
<p><strong>Retire</strong>: Replace or decommission devices after a failure, upgrade cycle, or at the end of the service lifetime.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_iot_hub_device_identity_and_registration"><a class="anchor" href="#_iot_hub_device_identity_and_registration"></a>IoT Hub Device Identity and Registration</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_identity_registry"><a class="anchor" href="#_identity_registry"></a>Identity Registry</h3>
<div class="ulist">
<ul>
<li>
<p>A device must have an entry in the IoT Hub identity registry before it can connect to an IoT Hub.</p>
</li>
<li>
<p>The deviceID is case-sensitive.</p>
</li>
<li>
<p>The identity registry is a REST-capable collection of device identity resources.</p>
</li>
<li>
<p>IoT Hub creates a set of resources for every device in the identity registry such as the queue that contains in-flight cloud-to-device messages.</p>
</li>
<li>
<p>Use the identity registry when you need to:</p>
<div class="ulist">
<ul>
<li>
<p>Provision devices that connect to your IoT hub.</p>
</li>
<li>
<p>Control per-device access to your hub&#8217;s device-facing endpoints.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_module_identity"><a class="anchor" href="#_module_identity"></a>Module Identity</h3>
<div class="ulist">
<ul>
<li>
<p>You can create module identities under a device identity.</p>
</li>
<li>
<p>Each module identity can be configured with an independent connection to IoT hub.</p>
</li>
<li>
<p>You can seperate access control permissions.</p>
</li>
<li>
<p>You can create up to 20 module identites under a device identity.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_identity_registry_operations"><a class="anchor" href="#_identity_registry_operations"></a>Identity registry operations</h3>
<div class="ulist">
<ul>
<li>
<p>Identity registry exposes the following operations:</p>
<div class="ulist">
<ul>
<li>
<p>Create device or module identity</p>
</li>
<li>
<p>Update device or module identity</p>
</li>
<li>
<p>Retreive device or module identity</p>
</li>
<li>
<p>Delete device or module identity</p>
</li>
<li>
<p>List up to 1000 identities</p>
</li>
<li>
<p>Export device identities to Azure blob storage</p>
</li>
<li>
<p>Import device identities from Azure blob storage</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_device_creation"><a class="anchor" href="#_device_creation"></a>Device Creation</h3>
<div class="ulist">
<ul>
<li>
<p>You need to specify the Device ID and the authentication type when creating a new device.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_iot_hub_device_twins_concept"><a class="anchor" href="#_iot_hub_device_twins_concept"></a>IoT Hub Device Twins Concept</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Device Twins are json documents managed by IoT Hub that store device state information associated with a physical device.</p>
</li>
<li>
<p>This information includes metadata, configurations, and conditions.</p>
</li>
<li>
<p>Azure IoT Hub maintains a device twin for each registered device.</p>
</li>
<li>
<p>Device twins are implicity created and deleted when a device identity is created or deleted in IoT Hub.</p>
</li>
<li>
<p>A device twin is a JSON document that includes:</p>
<div class="ulist">
<ul>
<li>
<p><em>Tags</em>. A solution back end can read from and write to. Tags are not visible to device apps.</p>
</li>
<li>
<p><em>Desired properties</em>. The solution back end can set desired properties, and the device app can read them. The device app can also receive notifications of changes in the desired properties.</p>
</li>
<li>
<p><em>Reported properties</em>. The device app can set reported properties, and the solution back end can read and query them.</p>
</li>
<li>
<p><em>Device identity properties</em>. The read-only properties from the corresponding device identity stored in the identity registry</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="https://learn.microsoft.com/en-us/training/wwl-azure/examine-iot-device-lifecycle-concepts/media/m02-l01-device-twin-diagram-03c0f21f.png" alt="m02 l01 device twin diagram 03c0f21f">
</div>
<div class="title">Figure 2. Source Microsoft Learn</div>
</div>
<div class="listingblock">
<div class="title">Sample JSON</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
    "deviceId": "devA",
    "etag": "AAAAAAAAAAc=",
    "status": "enabled",
    "statusReason": "provisioned",
    "statusUpdateTime": "0001-01-01T00:00:00",
    "connectionState": "connected",
    "lastActivityTime": "2015-02-30T16:24:48.789Z",
    "cloudToDeviceMessageCount": 0,
    "authenticationType": "sas",
    "x509Thumbprint": {
        "primaryThumbprint": null,
        "secondaryThumbprint": null
    },
    "version": 2,
    "tags": {
        "$etag": "123",
        "deploymentLocation": {
            "building": "43",
            "floor": "1"
        }
    },
    "properties": {
        "desired": {
            "telemetryConfig": {
                "sendFrequency": "5m"
            },
            "$metadata": {...},
            "$version": 1
        },
        "reported": {
            "telemetryConfig": {
                "sendFrequency": "5m",
                "status": "success"
            },
            "batteryLevel": 55,
            "$metadata": {...},
            "$version": 4
        }
    }
}</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_device_twins_usage"><a class="anchor" href="#_device_twins_usage"></a>Device Twins Usage</h3>
<div class="paragraph">
<p>Use device twins to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Store device-specific metadata in the cloud. For example, the deployment location of a vending machine.</p>
</li>
<li>
<p>Report current state information such as available capabilities and conditions from your device app. For example, a device is connected to your IoT hub over cellular or WiFi.</p>
</li>
<li>
<p>Synchronize the state of long-running workflows between device app and back-end app. For example, when the solution back end specifies the new firmware version to install, and the device app reports the various stages of the update process.</p>
</li>
<li>
<p>Query your device metadata, configuration, or state.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_iot_hub_module_identity_and_module_twins"><a class="anchor" href="#_iot_hub_module_identity_and_module_twins"></a>IoT Hub Module Identity and Module Twins</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Each module identity implicitly generates a module twin.</p>
</li>
<li>
<p>Module twins are JSON documents that store module information including metadata, configurations, and conditions.</p>
</li>
<li>
<p>SDKs enable you to create modules where each one opens an independent connection to IoT Hub.</p>
</li>
<li>
<p>For example, if your vending machine has 3 different sensors controlled by different departments in your company, you can create a module for each sensor.</p>
</li>
<li>
<p>This way, each department is only able to create jobs or direct methods for the sensor that they control, avoiding conflicts and user errors.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_iot_hub_device_monitoring"><a class="anchor" href="#_iot_hub_device_monitoring"></a>IoT Hub Device Monitoring</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Device monitoring is used to track the overall device collection health, the status of ongoing operations, and to alert operators to issues that might require their attention.</p>
</li>
<li>
<p>Device twin desired and reported properties can be used to monitor a target condition, target content, or device metrics.</p>
<div class="ulist">
<ul>
<li>
<p>The Target condition defines the scope of device twins to be updated. It is specified as a query on twin tags and/or reported properties.</p>
</li>
<li>
<p>The Target content defines the desired properties to be added or updated in the targeted device twins. The content includes a path to the section of desired properties to be changed.</p>
</li>
<li>
<p>The Metrics define the summary counts of various configuration states such as Success, In Progress, and Error.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_iot_hub_device_retirements"><a class="anchor" href="#_iot_hub_device_retirements"></a>IoT Hub Device Retirements</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Use the IoT Hub identity registry for securely revoking device identities and credentials.</p>
</li>
<li>
<p>You can disable devices by updating the status property of an identity in the identity registry.</p>
</li>
<li>
<p>The disable feature is not available for modules.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_iot_device_configuration_and_communication_protocols"><a class="anchor" href="#_iot_device_configuration_and_communication_protocols"></a>IoT Device Configuration and Communication Protocols</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_protocols"><a class="anchor" href="#_protocols"></a>Protocols</h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Protocol</th>
<th class="tableblock halign-left valign-top">When you should use this protocol.</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MQTT MQTT over WebSocket</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Use with devices that have their own per-device credentials.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">AMQP AMQP over websocket</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Use on field gateways and cloud gateways to take advantage of connection multiplexing across devices.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">HTTPS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Use for devices that support other protocols.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_ports"><a class="anchor" href="#_ports"></a>Ports</h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Protocol</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Port</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MQTT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">8883</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MQTT over WebSockets</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">443</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">AMQP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5671</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">AMQP over WebSockets</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">443</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">HTTPS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">443</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_iot_devices_and_device_provisioning"><a class="anchor" href="#_iot_devices_and_device_provisioning"></a>IoT Devices and Device Provisioning</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_provisioning_process_2"><a class="anchor" href="#_provisioning_process_2"></a>Provisioning Process</h3>
<div class="paragraph">
<p>There are two phases in the provisioning/deployment process for a device:-</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The manufacturing phase in which the device is created and prepared at the factory.</p>
</li>
<li>
<p>The cloud setup phase in which the Device Provisioning Service is configured for automated provisioning.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_manufacturing_process_phase"><a class="anchor" href="#_manufacturing_process_phase"></a>Manufacturing Process Phase</h4>
<div class="ulist">
<ul>
<li>
<p>In this phase, the device is programmed with the provisioning service information,</p>
</li>
<li>
<p>This enables it to call the provisioning service to get its connection info/IoT solution assignment when it is switched on.</p>
</li>
<li>
<p>Also, in this phase, the manufacturer supplies the device deployer/operator with the identifying key information for the device.</p>
</li>
<li>
<p>This identifying information could be an X.509 certificate or the public portion of a trusted platform module.</p>
</li>
<li>
<p>These services are offered by many silicon manufacturers today.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_cloud_setup_phase"><a class="anchor" href="#_cloud_setup_phase"></a>Cloud setup phase</h4>
<div class="ulist">
<ul>
<li>
<p>This phase is about configuring the cloud for proper automatic provisioning.</p>
</li>
<li>
<p>There are two types of users involved</p>
<div class="ulist">
<ul>
<li>
<p>A device operator - someone who knows how devices are intially set up.</p>
</li>
<li>
<p>A solution operator - someonw who knows how devices are to be split among the IoT hubs.</p>
</li>
</ul>
</div>
</li>
<li>
<p>A one-time initial setup of the provisioning service must occur.</p>
</li>
<li>
<p>It is done by the solution operator.</p>
</li>
<li>
<p>The device operator then needs to enroll the device.</p>
</li>
<li>
<p>The device operator takes the key identifying information from the manufacturer and adds it to the enrollment list.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_linked_iot_hubs"><a class="anchor" href="#_linked_iot_hubs"></a>Linked IoT Hubs</h4>
<div class="ulist">
<ul>
<li>
<p>The Device Provisioning Service can only provision devices to IoT hubs that have been linked to it.</p>
</li>
<li>
<p>Linking an IoT hub to an instance of the DPS gives the service read/write permissions to the IoT hub&#8217;s device registry with the link.</p>
</li>
<li>
<p>A DPS can register a device ID and set the initial configuration in the device twin.</p>
</li>
<li>
<p>Linked IoT hubs may be in any Azure region.</p>
</li>
<li>
<p>You may link hubs in other subscriptions to your provisioning service.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_allocation_policy"><a class="anchor" href="#_allocation_policy"></a>Allocation policy</h4>
<div class="ulist">
<ul>
<li>
<p>The service level setting that determines how DPS assigns devices to an IoT hub.</p>
</li>
<li>
<p>There are there supported policies:</p>
<div class="ulist">
<ul>
<li>
<p>Evenly weighted distribution. The default setting. Linked IoT hubs are equally likely to have devices provisioned to them.</p>
</li>
<li>
<p>Lowest Latency. Devices are provisioned to an IoT hub with the lowest latency.</p>
</li>
<li>
<p>Static Configuration via the enrollment list: specification of the desired IoT hub in the enrollment list takes priority over the service-level allocation policy.</p>
</li>
<li>
<p>Custom (Use Azure Function): A custom allocation policy using custom code in an Azure function.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_enrollment"><a class="anchor" href="#_enrollment"></a>Enrollment</h4>
<div class="ulist">
<ul>
<li>
<p>An enrollment is the record of devices that may register through autoprovisioning.</p>
</li>
<li>
<p>Two types of enrollments are supported:</p>
<div class="ulist">
<ul>
<li>
<p>Group enrollment: Recommended for a large number of devices that share a desired initial configuration, or for devices all going to the same tenant.</p>
</li>
<li>
<p>Individual enrollment: Recommended for devices that require unique initial configurations, or for devices that can only authenticate using SAS tokens via TPM attestation.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Enrollment record contains information about the device or group of devices:</p>
<div class="ulist">
<ul>
<li>
<p>The attestation mechanism used by the device.</p>
</li>
<li>
<p>The optional intial desired configuration.</p>
</li>
<li>
<p>Desired IoT hub.</p>
</li>
<li>
<p>The desired device ID.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_registration"><a class="anchor" href="#_registration"></a>Registration</h4>
<div class="ulist">
<ul>
<li>
<p>A registration is the record of a device successfully registering/provisioning to an IoT Hub via the Device Provisioning Service.</p>
</li>
<li>
<p>Registration records are created automatically; they can be deleted, but they cannot be updated.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_operations"><a class="anchor" href="#_operations"></a>Operations</h4>
<div class="ulist">
<ul>
<li>
<p>Operations are the billing unit of the Device Provisioning Service.</p>
</li>
<li>
<p>One operation is the successful completion of one instruction to the service.</p>
</li>
<li>
<p>Operations include device registrations and re-registrations; service-side changes such as adding enrollment list entries, and updating enrollment list entries.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_iot_device_enrollment_concepts"><a class="anchor" href="#_iot_device_enrollment_concepts"></a>IoT Device Enrollment Concepts</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>The manufacturer is responsible for encoding the device identity info, and the Device Provisioning Service registration URL.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_id_scope"><a class="anchor" href="#_id_scope"></a>ID Scope</h3>
<div class="ulist">
<ul>
<li>
<p>The ID scope is assigned to a DPS when it is created by the user.</p>
</li>
<li>
<p>It is used to uniquely identify the specific provisioning service the device will register through.</p>
</li>
<li>
<p>The ID scope is generated by the service and is immutable, which guarantees uniquess.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_registration_id"><a class="anchor" href="#_registration_id"></a>Registration ID</h3>
<div class="ulist">
<ul>
<li>
<p>The registration ID uniquely identifies a device in the Device Provisioning Service.</p>
</li>
<li>
<p>The registration ID must be unique in the provisioning service ID scope.</p>
</li>
<li>
<p>Each device must have a registration ID.</p>
</li>
<li>
<p>The registration ID is alphanumeric, case insensitive, and may contain special characters including colon, period, underscore, and hyphen.</p>
</li>
<li>
<p>When TPM attestation is used, the registration ID is provided by the TPM itself.</p>
</li>
<li>
<p>When X.509-based attestation is used, the registration ID is provided by the subject name of the certificate.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_device_id"><a class="anchor" href="#_device_id"></a>Device ID</h3>
<div class="ulist">
<ul>
<li>
<p>The device ID is the ID as it appears in IoT Hub.</p>
</li>
<li>
<p>The desired ID may be set in the enrollment entry.</p>
</li>
<li>
<p>Setting the desired ID is only supported in individual enrollments.</p>
</li>
<li>
<p>If no desired device ID is specified in the enrollment list, the registration ID is used as the device ID when registering the device.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_attestation_mechanism"><a class="anchor" href="#_attestation_mechanism"></a>Attestation mechanism</h3>
<div class="ulist">
<ul>
<li>
<p>An attestation mechanism is a method used for confirming a device&#8217;s identity.</p>
</li>
<li>
<p>IoT Hub uses "authentication scheme" for a similar concept in that service.</p>
</li>
<li>
<p>The DPS supports the following forms of attestation:</p>
<div class="ulist">
<ul>
<li>
<p>X.509 certificates based on the standard X.509 certificate authentication flow.</p>
</li>
<li>
<p>Trusted Platform Module (TPM) based on a nonce challenge, using the TPM standard for keys to present a signed Shared Access Signature (SAS) token. TPM attestation does not require a physical TPM on the device, but the service expects to attest using the endorsement key per the TPM spec.</p>
</li>
<li>
<p>Symmetric Key based on shared access signature (SAS) security tokens, which include a hashed signature and an embedded expiration.</p>
</li>
</ul>
</div>
</li>
<li>
<p>A hardware Security Module (HSM) is recommended for secure, hardware-based storage of device secrets, and is the most secure form of secret storage.</p>
</li>
<li>
<p>Both X.509 certificates and SAS tokens can be stored in HSM.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_iot_device_enrollment_types"><a class="anchor" href="#_iot_device_enrollment_types"></a>IoT Device Enrollment Types</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_individual_enrollments"><a class="anchor" href="#_individual_enrollments"></a>Individual Enrollments</h3>
<div class="ulist">
<ul>
<li>
<p>It is an entry for a single device that may register.</p>
</li>
<li>
<p>Individual enrollments may use X.509 certificates or SAS tokens as attestation mechanisms.</p>
</li>
<li>
<p>Individual enrollments may have the desired IoT hub device ID specified.</p>
</li>
<li>
<p>Individual enrollments are recommended for devices with unique initial configurations, or for devices that can only use SAS tokens via TPM or virtual TPM as the attestation mechanism.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_group_enrollments"><a class="anchor" href="#_group_enrollments"></a>Group Enrollments</h3>
<div class="ulist">
<ul>
<li>
<p>An enrollment group is a group of devices that share a specific attestation mechanism.</p>
</li>
<li>
<p>Enrollment groups support both X.509 and symmetric keys.</p>
</li>
<li>
<p>All devices in the X.509 enrollment group present X.509 certificates that have been signed by the same root or intermediate Certificate Authority(CA).</p>
</li>
<li>
<p>Each device in the symmetric key enrollment group present SAS tokens derived from the group symmetric key.</p>
</li>
<li>
<p>The enrollment group name and certificate name must be alphanumeric, lowercase, and may contain hyphens.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_iot_device_x_509_certificate_attestation_process"><a class="anchor" href="#_iot_device_x_509_certificate_attestation_process"></a>IoT Device X.509 Certificate Attestation Process</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>X.509 certificates are typically arranged in a certificate chain of trust in which each certificate in the chain is signed by the private key of the next higher certificate, and so on, terminating in a self-signed root certificate.</p>
</li>
<li>
<p>This arrangement establishes a delegated chain of trust from the root certificate generated by a trusted root certificate authority (CA) down through each intermediate CA to the end-entity "leaf" certificate installed on the device.</p>
</li>
<li>
<p>Often the certificate chain represents some logical or physical heirarchy associated with devices.</p>
</li>
<li>
<p>For example, a manufacturer may:</p>
<div class="ulist">
<ul>
<li>
<p>Issue a self-signed root CA certificate.</p>
</li>
<li>
<p>Use the root certificate to generate a unique intermediate CA certificate for each factory.</p>
</li>
<li>
<p>Use each factory&#8217;s certificate to generate a unique intermediate CA certificate for each production line in the plant.</p>
</li>
<li>
<p>And finally, use the production line certificate to generate a unique device (end-entity) certificate for each device manufactured on the line.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_root_certificate"><a class="anchor" href="#_root_certificate"></a>Root Certificate</h3>
<div class="ulist">
<ul>
<li>
<p>A root certificate is a self-signed X.509 certificate representing a certificate authority (CA).</p>
</li>
<li>
<p>It is the terminus, or trust anchor, of the certificate chain.</p>
</li>
<li>
<p>Root certificates can be self-issued by an organization or purchased from a root certificate authority.</p>
</li>
<li>
<p>The root certificate can also be referred to as a root CA certificate.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_intermediate_certificate"><a class="anchor" href="#_intermediate_certificate"></a>Intermediate Certificate</h3>
<div class="ulist">
<ul>
<li>
<p>An intermediate certificate is an X.509 certificate, which has been signed by the root certificate (or by another intermediate certificate with the root certificate in its chain).</p>
</li>
<li>
<p>The last intermediate certificate in a chain is used to sign the leaf certificate.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_end_entity_leaf_certificate"><a class="anchor" href="#_end_entity_leaf_certificate"></a>End-entity "leaf" certificate</h3>
<div class="ulist">
<ul>
<li>
<p>The leaf certificate, or end-entity certificate, identifies the certificate holder.</p>
</li>
<li>
<p>It has the root certificate in its certificate chain and zero or more intermediate certificates.</p>
</li>
<li>
<p>The leaf certificate is not used to to sign any other certificates.</p>
</li>
<li>
<p>It uniquely identifies the device to the provisioning service and is sometimes referred to as the device certificate.</p>
</li>
<li>
<p>During authentication, the device uses the private key associated with its certificate to respond to a proof of possession challenge from the service.</p>
</li>
<li>
<p>Leaf certificates used with an Individual enrollment entry have a requirement that the Subject Name must be set to the registration ID of the Individual Enrollment entry.</p>
</li>
<li>
<p>Leaf certificates used with an Enrollment group entry should have the Subject Name set to the desired device ID, which will be shown in the Registration Records for the authenticated device in the enrollment group.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_controlling_device_access_to_the_provisioning_service_with_x_509_certificates"><a class="anchor" href="#_controlling_device_access_to_the_provisioning_service_with_x_509_certificates"></a>Controlling device access to the provisioning service with X.509 certificates</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>The provisioning service exposes two types of enrollment entry that you can use to control access for devices that use the X.509 attestation mechanism:</p>
<div class="ulist">
<ul>
<li>
<p>Individual enrollment entries are configured with the device certificate associated with a specific device. These entries control enrollments for specific devices.</p>
</li>
<li>
<p>Enrollment group entries are associated with a specific intermediate or root CA certificate. These entries control enrollments for all devices that have that intermediate or root certificate in their certificate chain.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_process"><a class="anchor" href="#_process"></a>Process</h3>
<div class="ulist">
<ul>
<li>
<p>When a device connects to a provisioning service, if an individual enrollment for the device exists, the provisioning service applies that entry.</p>
</li>
<li>
<p>If there is no individual enrollment for the device and an enrollment group for the first intermediate certificate in the device&#8217;s certificate chain exists, the service applies that entry, and so on, up the chain to the root.</p>
</li>
<li>
<p>The service applies the first applicable entry such that:</p>
<div class="ulist">
<ul>
<li>
<p>If the first enrollment entry found is enabled, the service provisions the device.</p>
</li>
<li>
<p>If the first enrollment entry found is disabled, the service does not provision the device.</p>
</li>
<li>
<p>If no enrollment entry is found for any of the certificates in the device&#8217;s certificate chain, the service does not provision the device.</p>
</li>
</ul>
</div>
</li>
<li>
<p>This mechanism and the hierarchical structure of certificate chains provides powerful flexibility in how you can control access for both individual devices and groups of devices.</p>
</li>
<li>
<p>For example, imagine five devices with the following certificate:</p>
<div class="ulist">
<ul>
<li>
<p>Device 1: root certificate &#8594; certificate A &#8594; device 1 certificate</p>
</li>
<li>
<p>Device 2: root certificate &#8594; certificate A &#8594; device 2 certificate</p>
</li>
<li>
<p>Device 3: root certificate &#8594; certificate A &#8594; device 3 certificate</p>
</li>
<li>
<p>Device 4: root certificate &#8594; certificate B &#8594; device 4 certificate</p>
</li>
<li>
<p>Device 5: root certificate &#8594; certificate B &#8594; device 5 certificate</p>
</li>
</ul>
</div>
</li>
<li>
<p>Initially, you can create a single enabled group enrollment entry for the root certificate to enable access for all five devices.</p>
</li>
<li>
<p>If certificate B later becomes compromised, you can create a disabled enrollment group entry for certificate B to prevent Device 4 and Device 5 from enrolling.</p>
</li>
<li>
<p>If still later Device 3 becomes compromised, you can create a disabled individual enrollment entry for its certificate.</p>
</li>
<li>
<p>This revokes access for Device 3, but still allows Device 1 and Device 2 to enroll.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_iot_device_hardware_security_module"><a class="anchor" href="#_iot_device_hardware_security_module"></a>IoT Device Hardware Security Module</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>The hardware security module, or HSM, is used for secure, hardware based storage of device secrets, and is the most secure form of secret storage.</p>
</li>
<li>
<p>Both X.509 certificates and SAS tokens can be stored in the HSM.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_trusted_platform_module"><a class="anchor" href="#_trusted_platform_module"></a>Trusted Platform Module</h3>
<div class="ulist">
<ul>
<li>
<p>TPM refers to a standard for securely storing keys used to authenticate the platform.</p>
</li>
<li>
<p>TPM can also refer to the I/O interface used to interact with the modules implementing the standard.</p>
</li>
<li>
<p>TPMs can exist as discrete hardware, integrated hardware, firmware-based, or software-based.</p>
</li>
<li>
<p>Device Provisioning service only supports TPM 2.0.</p>
</li>
<li>
<p>TPM attestation is based on a nonce challenge, which uses the endorsement and storage root keys to present a signed Shared Access Signature (SAS) token.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_endorsement_key"><a class="anchor" href="#_endorsement_key"></a>Endorsement key</h3>
<div class="ulist">
<ul>
<li>
<p>The endorsement key is an asymmetric key contained inside the TPM.</p>
</li>
<li>
<p>It is internally generated or injected at manufacture time.</p>
</li>
<li>
<p>It is unique for every TPM.</p>
</li>
<li>
<p>It cannot be changed or removed.</p>
</li>
<li>
<p>The private key portion of the endorsement key is never released outside of the TPM.</p>
</li>
<li>
<p>The public portion of the endorsement key is used to recognize a genuine TPM.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_storage_root_key"><a class="anchor" href="#_storage_root_key"></a>Storage root key</h3>
<div class="ulist">
<ul>
<li>
<p>The storage root key is stored in the TPM.</p>
</li>
<li>
<p>It is used to protect the TPM keys created by applications.</p>
</li>
<li>
<p>These cannot be used without the TPM.</p>
</li>
<li>
<p>The storage root key is generated when you take ownership of the TPM.</p>
</li>
<li>
<p>When you clear the TPM so a new user can take ownership, a new storage root key is generated.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_iot_device_trusted_platform_module_tpm_attestation_process"><a class="anchor" href="#_iot_device_trusted_platform_module_tpm_attestation_process"></a>IoT Device Trusted Platform Module (TPM) Attestation Process</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>TPM attestation uses endorsement key (EK) as the secure root of trust.</p>
</li>
<li>
<p>The EK is unique to the TPM.</p>
</li>
<li>
<p>Changing the EK changes the device into a new one.</p>
</li>
<li>
<p>TPMs have another type of key called the storage root key (SRK).</p>
</li>
<li>
<p>An SRK may be generated by the TPMs owner after taking ownership.</p>
</li>
<li>
<p>Taking ownership is a way of saying "Someone sets a password on the HSM".</p>
</li>
<li>
<p>If a TPM device is sold to a new owner, the new owner can take ownership of the TPM to generate a new SRK.</p>
</li>
<li>
<p>The SRK provides a sandbox for the owner to store their keys and provide access revocability if the device or TPM is sold.</p>
</li>
<li>
<p>Once a device has been setup, it will have both an SRK and an EK available for use.</p>
</li>
<li>
<p>TPM ownership could mean many things, follow the instructions relevant to your system to take ownership.</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="https://learn.microsoft.com/en-us/training/wwl-azure/examine-device-provisioning-service-terms-concepts/media/m03-l01-device-provisioning-service-trusted-platform-module-ownership-2e2f42a8.png" alt="m03 l01 device provisioning service trusted platform module ownership 2e2f42a8">
</div>
<div class="title">Figure 3. Source Microsoft Learn</div>
</div>
<div class="sect2">
<h3 id="_high_level_attestation_process"><a class="anchor" href="#_high_level_attestation_process"></a>High-level Attestation Process</h3>
<div class="ulist">
<ul>
<li>
<p>The public part of the EK is used by the DPS for device enrollment.</p>
</li>
<li>
<p>The device vendor can read the EK_pub and upload it to the provisioning service.</p>
</li>
<li>
<p>The device will be recognized when it connects to the DPS.</p>
</li>
<li>
<p>The DPS does not check the SRK or owner.</p>
</li>
<li>
<p>Clearing the TPM erases customer data and not the EK.</p>
</li>
<li>
<p>The device will still be recognized by the DPS when it connects to provision.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_detailed_attestation_process"><a class="anchor" href="#_detailed_attestation_process"></a>Detailed Attestation Process</h3>
<div class="ulist">
<ul>
<li>
<p>The device connects to the DPS and requests to provision.</p>
</li>
<li>
<p>It provides the service its registration ID, an ID scope, and the EK_pub and SRK_pub from the TPM.</p>
</li>
<li>
<p>The service passes the encrypted nonce back to the device.</p>
</li>
<li>
<p>The device decrypts the encrypted nonce and uses that to sign a SAS token to connect again and finish provisioning.</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="https://learn.microsoft.com/en-us/training/wwl-azure/examine-device-provisioning-service-terms-concepts/media/step-one-request-provisioning-78fb84b8.png" alt="step one request provisioning 78fb84b8">
</div>
<div class="title">Figure 4. Source Microsoft Learn</div>
</div>
</div>
<div class="sect2">
<h3 id="_nonce_challenge"><a class="anchor" href="#_nonce_challenge"></a>Nonce challenge</h3>
<div class="ulist">
<ul>
<li>
<p>The device takes the nonce and uses the private portion of the EK and SRK to decrypt the nonce into the TPM.</p>
</li>
<li>
<p>The order of nonce encryption delegates trust from the EK, which is immutable, to the SRK, which can change if a new owner takes ownership of the TPM.</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="https://learn.microsoft.com/en-us/training/wwl-azure/examine-device-provisioning-service-terms-concepts/media/step-two-nonce-challenge-a87bd4ee.png" alt="step two nonce challenge a87bd4ee">
</div>
<div class="title">Figure 5. Source Microsoft Learn</div>
</div>
</div>
<div class="sect2">
<h3 id="_validate_the_nonce_and_receive_credentials"><a class="anchor" href="#_validate_the_nonce_and_receive_credentials"></a>Validate the nonce and receive credentials</h3>
<div class="ulist">
<ul>
<li>
<p>The device then signs a SAS token using the decrypted nonce.</p>
</li>
<li>
<p>It reestablishes connection to the DPS using the signed SAS token.</p>
</li>
<li>
<p>With the Nonce challenge completed, the service allows the device to provision.</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="https://learn.microsoft.com/en-us/training/wwl-azure/examine-device-provisioning-service-terms-concepts/media/m03-l01-device-provisioning-service-trusted-platform-module-attestation-step-three-validation-922a60fc.png" alt="m03 l01 device provisioning service trusted platform module attestation step three validation 922a60fc">
</div>
<div class="title">Figure 6. Source Microsoft Learn</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_iot_device_symmetric_key_attestation"><a class="anchor" href="#_iot_device_symmetric_key_attestation"></a>IoT Device Symmetric Key Attestation</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Symmetric key attestation is a simple approach to authenticating a device with DPS.</p>
</li>
<li>
<p>Can be used if you do not have strict security requirements.</p>
</li>
<li>
<p>It is useful for legacy devices with limited security functionality.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_symmetric_key_creation"><a class="anchor" href="#_symmetric_key_creation"></a>Symmetric Key Creation</h3>
<div class="ulist">
<ul>
<li>
<p>The DPS creates new symmetric keys with a default length of 32 bytes when new enrollments are saved with the <strong>Auto generate keys</strong> option enabled.</p>
</li>
<li>
<p>You can also specify your own symmetric keys.</p>
</li>
<li>
<p>Your keys must have a key length between 16 bytes and 64 bytes.</p>
</li>
<li>
<p>The keys must be in valid Base64 format.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_sas_tokens"><a class="anchor" href="#_sas_tokens"></a>SAS tokens</h3>
<div class="paragraph">
<p>SAS tokens have the following form:-<br>
<code>SharedAccessSignature sig={signature}&amp;se={expiry}&amp;skn={policyName}&amp;sr={URL-encoded-resourceURI}</code></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Signature is the HMAC-SHA256 signature string produced by using the symmetric key or the enrollment group key. The key must be decoded from base64 before being used to perform the sha256 computation. The signature result must be url encoded.</p>
</li>
<li>
<p>resourceURI is the uri registration endpoint that can be accessed by this token. It starts with the scope ID for the DPS. for example, <code>{scope ID}/registrations/{registration ID}</code></p>
</li>
<li>
<p>expiry is the number of seconds since Jan 1970</p>
</li>
<li>
<p>url-encoded-resourceURI is the lower case URL-encoding of the lower case resource URI.</p>
</li>
<li>
<p>policyName is the name of the shared access policy to which this token refers. The policy name used when provisioning with symmetric key attestation is registration.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_iot_device_provisioning_process"><a class="anchor" href="#_iot_device_provisioning_process"></a>IoT Device Provisioning Process</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>The DPS automates many of the manual steps that are traditionally involved in provisioning devices.</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="https://learn.microsoft.com/en-us/training/wwl-azure/examine-device-provisioning-service-terms-concepts/media/m03-l01-device-provisioning-service-provisioning-flow-a8e493e4.png" alt="m03 l01 device provisioning service provisioning flow a8e493e4">
</div>
<div class="title">Figure 7. Source Microsoft Learn</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Device manufacturer adds the device registration information to the enrollment list in the Azure portal.</p>
</li>
<li>
<p>Device contacts the DPS set/embedded at the factory. The device passes identifying information to the DPS to prove its identity.</p>
</li>
<li>
<p>The DPS validates the identity of the device by validating the registration ID and key against the enrollment list entry using either a nonce challenge (TPM) or X.509 certificates.</p>
</li>
<li>
<p>The DPS registers the device with an IoT Hub and populates the device&#8217;s twin state.</p>
</li>
<li>
<p>The IoT hub returns the deviceID information to the provisioning service.</p>
</li>
<li>
<p>The DPS returns the IoT hub connection information to the device. The device can now start sending data directly to the IoT hub.</p>
</li>
<li>
<p>The device connects to IoT hub.</p>
</li>
<li>
<p>The device gets the desired state from its device twin in IoT hub.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_iot_device_autoprovisioning_operation"><a class="anchor" href="#_iot_device_autoprovisioning_operation"></a>IoT Device Autoprovisioning Operation</h2>
<div class="sectionbody">
<div class="imageblock">
<div class="content">
<img src="https://learn.microsoft.com/en-us/training/wwl-azure/examine-device-provisioning-service-terms-concepts/media/m03-l01-auto-provisioning-diagram-aac3c12a.png" alt="m03 l01 auto provisioning diagram aac3c12a">
</div>
<div class="title">Figure 8. Source Microsoft Learn</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Encode identity and registration URL</strong> - the manufacturer is responsible for encoding the device identity info, and the DPS registration URL</p>
</li>
<li>
<p><strong>Provide device identity</strong> - the manufacturer is responsible for communicating it to the operator or directly enrolling it to the DPS.</p>
</li>
<li>
<p><strong>Configure autoprovisioning</strong> - a one-time configuration of the Azure IoT Hub and IoT Hub Device Provisioning Service instances, establishing them and creating linkage between them.</p>
</li>
<li>
<p><strong>Enroll device identity</strong> - Identity is based on the attestation mechanism the device is designed to use, which allows the provisioning service to attest to the device&#8217;s authenticity during registration</p>
</li>
<li>
<p><strong>Build/Deploy registration software.</strong> - The Developer is responsible for building and deploying the registration software to the device, using the appropriate SDK.</p>
</li>
<li>
<p><strong>Bootup and register.</strong> - Initiated upon boot up by registration software, which is built using a Device Provisioning Service client SDK appropriate for the device and attestation mechanism. Upon successful registration, the device is provided with its IoT Hub unique device ID and connection information, allowing it to pull its initial configuration and begin the telemetry process.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_iot_device_reprovisioning_process"><a class="anchor" href="#_iot_device_reprovisioning_process"></a>IoT Device Reprovisioning Process</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_reprovisioning_scenarios"><a class="anchor" href="#_reprovisioning_scenarios"></a>Reprovisioning Scenarios</h3>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
Latency
</td>
<td class="hdlist2">
<p>As a device moves between locations, network latency can be improved by having the device migrated closed to the IoT hub.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
Multi-tenancy
</td>
<td class="hdlist2">
<p>A device may be reassigned to a new customer within an IoT solution. This new customer may use a different IoT hub.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
Solution change
</td>
<td class="hdlist2">
<p>A device could be moved into a new or updated IoT solution. This may require an IoT hub change.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
Quarantine
</td>
<td class="hdlist2">
<p>A device that is malfunctioning, compromised, or out-of-date may be reassigned to an IoT hub that can only update and get back in compliance. Once the device is functioning properly, it&#8217;s then migrated back to its main hub.</p>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_device_state_data"><a class="anchor" href="#_device_state_data"></a>Device State Data</h3>
<div class="ulist">
<ul>
<li>
<p>Device state data is composed of the device twin and device capabilities.</p>
</li>
<li>
<p>This data is stored in the Device Provisioning Service instance and the IoT hub that a device is assigned to</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="https://learn.microsoft.com/en-us/training/wwl-azure/examine-device-provisioning-service-terms-concepts/media/m03-l01-device-provisioning-service-reprovisioning-state-1-0f06266f.png" alt="m03 l01 device provisioning service reprovisioning state 1 0f06266f">
</div>
</div>
<div class="paragraph">
<p>When a device is initially provisioned with a DPS instance, the following steps are done:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The device sends a provisioning request to a DPS instance.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>The service instance authenticates the device identity based on an enrollment entry.</p>
</li>
<li>
<p>It then creates the initial configuration of the device state data.</p>
</li>
<li>
<p>The service instance assigns the device to an IoT hub based on the enrollment configuration.</p>
</li>
<li>
<p>It then returns that IoT hub assignment to the device.</p>
</li>
</ol>
</div>
</li>
<li>
<p>The provisioning service instance gives a copy of any intial device state data to the assigned IoT hub.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>The device connects to the assigned IoT hub and begins operations.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="ulist">
<ul>
<li>
<p>Over time, the device state data on the IoT hub may be updated by device operations and back-end operations.</p>
</li>
<li>
<p>The initial device state information stored in the DPS instance stays untouched.</p>
</li>
<li>
<p>This untouched device state data is the initial configuration.</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="https://learn.microsoft.com/en-us/training/wwl-azure/examine-device-provisioning-service-terms-concepts/media/m03-l01-device-provisioning-service-reprovisioning-state-2-ccaf3d23.png" alt="m03 l01 device provisioning service reprovisioning state 2 ccaf3d23">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>As a device moves between IoT hubs, it may also be necessary to migrate device state updated on the previous IoT hub over to the new IoT hub.</p>
</li>
<li>
<p>This migration is supported by reprovisioning policies in the DPS.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_reprovisioning_policies"><a class="anchor" href="#_reprovisioning_policies"></a>Reprovisioning policies</h3>
<div class="ulist">
<ul>
<li>
<p>A device usually supports a method to manually trigger provisioning on demand.</p>
</li>
<li>
<p>The reprovisioning policy on an enrollment entry determines how the DPS handles provisioning requests.</p>
</li>
<li>
<p>The policy also determines whether device state data should be migrated during reprovisioning.</p>
</li>
<li>
<p>The same policies are available for individual enrollments and enrollment groups:</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="https://learn.microsoft.com/en-us/training/wwl-azure/examine-device-provisioning-service-terms-concepts/media/m03-l01-device-provisioning-service-reprovisioning-state-3-499f65e7.png" alt="m03 l01 device provisioning service reprovisioning state 3 499f65e7">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Reprovision and migrate data:</p>
<div class="ulist">
<ul>
<li>
<p>This policy is the default for new enrollment entries.</p>
</li>
<li>
<p>This policy takes action when devices associated with the enrollment entry submint a new request (1).</p>
</li>
<li>
<p>The updated device state information from that initial IoT hub will be migrated over to the new IoT hub (2).</p>
</li>
<li>
<p>During migration, the device&#8217;s status will be reported as Assigning.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="https://learn.microsoft.com/en-us/training/wwl-azure/examine-device-provisioning-service-terms-concepts/media/m03-l01-device-provisioning-service-reprovisioning-state-4-bb4ef6ea.png" alt="m03 l01 device provisioning service reprovisioning state 4 bb4ef6ea">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Reprovision and reset to initial config:</p>
<div class="ulist">
<ul>
<li>
<p>This policy takes action when devices associated with the enrollment entry submit a new provisioning request (1).</p>
</li>
<li>
<p>The initial configuration data that the provisioning service instance received when the device was provisioned is provided to the new IoT hub (2).</p>
</li>
<li>
<p>During migration, the device&#8217;s status will be reported as Assigning.</p>
</li>
<li>
<p>This policy is often used for a factory reset without changing IoT hubs.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="ulist">
<ul>
<li>
<p>Never reprovision: The device is never reassigned to a different hub. This policy is provided for managing backwards compatibility.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_iot_device_provisioning_service_azure_cli_commands"><a class="anchor" href="#_iot_device_provisioning_service_azure_cli_commands"></a>IoT Device Provisioning Service Azure CLI Commands</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_dps_service_commands"><a class="anchor" href="#_dps_service_commands"></a>DPS Service Commands</h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Service Commands</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">az iot dps create</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Create an Azure IoT Hub DPS instance.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">az iot dps delete</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Delete an Azure IoT Hub DPS instance.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">az iot dps list</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List Azure IoT Hub Device Provisioning Service instances.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">az iot dps show</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get the details of an Azure IoT Hub Device Provisioning instance.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">az iot dps update</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Update an Azure IoT Hub Device Provisioning Service instance.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_access_policy_commands"><a class="anchor" href="#_access_policy_commands"></a>Access Policy Commands</h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Access Policy Commands</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">az iot dps access-policy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Manage Azure IoT Hub DPS access policies.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">az iot dps access-policy create</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Create a new shared access policy in an Azure IoT Hub DPS instance.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">az iot dps access-policy delete</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Delete a shared access policies in an Azure IoT Hub DPS instance.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">az iot dps access-policy list</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List all shared access policies in an Azure IoT Hub DPS.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">az iot dps access-policy show</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Show details of a shared access policy in an Azure IoT Gub DPS instance.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">az iot dps access-policy update</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Update a shared access policy in an Azure IoT Hub DPS instance.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_certificate_commands"><a class="anchor" href="#_certificate_commands"></a>Certificate Commands</h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">az iot dps certificate</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Manage Azure IoT Hub DPS certificates.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">az iot dps certificate create</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Create/upload an Azure IoT Hub DPS certificate.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">az iot dps certificate delete</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Delete an Azure IoT Hub DPS certificate.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">az iot dps certificate generate-verification-code</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Generate a verification code for an Azure IoT Hub DPS certificate.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">az iot dps certificate list</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List all certificates contained within an Azure IoT Gub dps</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">az iot dps certificate show</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Show information about a particular Azure IoT Hub DPS certificate.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">az iot dps certificate update</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Update an Azure IoT Hub DPS certificate</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">az iot dps certificate verify</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Verify an Azure IoT Hub DPS certificate.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_linked_hub_commands"><a class="anchor" href="#_linked_hub_commands"></a>Linked Hub Commands</h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Linked Hub Commands</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Descriptions</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">az iot dps linked-hub</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Manage Azure IoT Hub DPS linked IoT hubs.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">az iot dps linked-hub create</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Create a linked IoT hub in an Azure IoT Hub DPS instance.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">az iot dps linked-hub delete</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Update (delete) a linked IoT hub in an Azure IoT Hub DPS instance.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">az iot dps linked-hub list</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List all linked IoT hubs in an Azure IoT DPS instance.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">az iot dps linked-hub show</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Show details of a linked IoT hub in an Azure IoT Hub DPS instance.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">az iot dps linked-hub update</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Update a linked IoT hub in an Azure IoT Hub DPS instance.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_iot_device_provisioning_sdk"><a class="anchor" href="#_iot_device_provisioning_sdk"></a>IoT Device Provisioning SDK</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Azure Provisioning device and service SDKs for C# can be downloaded from NuGet as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Provisioning Device Client SDK</p>
</li>
<li>
<p>Provisioning Service Client SDK</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_provisioning_device_sdk"><a class="anchor" href="#_provisioning_device_sdk"></a>Provisioning Device SDK</h3>
<div class="ulist">
<ul>
<li>
<p>This SDK supports the following protocols: MQTT, MQTT-WS, AMQP, AMQP-WS, and HTTPS.</p>
</li>
<li>
<p>TPM Individual Enrollment:</p>
<div class="ulist">
<ul>
<li>
<p>This SDK supports connecting your device to the DPS via individual enrollment using TPM.</p>
</li>
<li>
<p>TPM over MQTT (and MQTT-WS) is currrently not supported by the DPS</p>
</li>
</ul>
</div>
</li>
<li>
<p>X.509 Indivicual Enrollment:</p>
<div class="ulist">
<ul>
<li>
<p>This SDK supports connecting your device to the DPS via individual enrollment using X.509 root certificate.</p>
</li>
</ul>
</div>
</li>
<li>
<p>X.509 Enrollment Group</p>
<div class="ulist">
<ul>
<li>
<p>This SDK supports connecting your device to the DPS via individual enrollment using X.509 leaf certificate.</p>
</li>
</ul>
</div>
</li>
<li>
<p>WebSocket support for MQTT/AMQP is limited to .NET Framework 4.x</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_provisioning_service_sdk"><a class="anchor" href="#_provisioning_service_sdk"></a>Provisioning Service SDK</h3>
<div class="ulist">
<ul>
<li>
<p>This SDK can be used to programmatically enroll devices.</p>
</li>
<li>
<p>CRUD Operation with TPM Individual Enrollment</p>
<div class="ulist">
<ul>
<li>
<p>Programmatically manage device enrollment using TPM with the service SDK.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Bulk CRUD Operation with TPM Individual Enrollment</p>
<div class="ulist">
<ul>
<li>
<p>Programmatically manage device enrollment using TPM with the service SDK.</p>
</li>
</ul>
</div>
</li>
<li>
<p>CRUD Operation with X.509 Individual Enrollment</p>
<div class="ulist">
<ul>
<li>
<p>Programmatically manage device enrollment using X.509 individual enrollment with the service SDK.</p>
</li>
</ul>
</div>
</li>
<li>
<p>CRUD Operation with X.509 Group Enrollment</p>
<div class="ulist">
<ul>
<li>
<p>Programmatically manage device enrollment using X.509 group enrollment with the service SDK.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Query enrollments</p>
<div class="ulist">
<ul>
<li>
<p>Programmatically query registration states with the service SDK.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_iot_device_trusted_platform_module_tpm_simulator"><a class="anchor" href="#_iot_device_trusted_platform_module_tpm_simulator"></a>IoT Device Trusted Platform Module (TPM) Simulator</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>In production, TPM is located on the device, either as discrete hardware, integrated hardware, or firmware-based.</p>
</li>
<li>
<p>In testing phase, a software-based TPM simulator is provided to developers.</p>
</li>
<li>
<p>This simulator is only available on the Windows platform for now.</p>
</li>
<li>
<p>Clone the Github repository: <code>git clone <a href="https://github.com/Azure/azure-iot-sdk-java.git" class="bare">https://github.com/Azure/azure-iot-sdk-java.git</a></code>.</p>
</li>
<li>
<p>Navigate to the TPM simulator folder under <code>azure-iot-sdk-java/provisioning/provisioning-tool/tpm-simulator/</code>.</p>
</li>
<li>
<p>Run Simulator.exe prior to running any client application for provisioning device.</p>
</li>
<li>
<p>Let the simulator run in the background throughout the provisioning process to obtain registration ID and Endorsement Key. Both values are only valid for one instance of the run.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_iot_device_x_509_certificate_generator"><a class="anchor" href="#_iot_device_x_509_certificate_generator"></a>IoT Device X.509 certificate Generator</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>For production environment, purchase an X.509 CA certificate from a public root certificate authority.</p>
</li>
<li>
<p>For testing environment, you can generate an X.509 root certificate or X.509 certificate chain using:</p>
<div class="ulist">
<ul>
<li>
<p>OpenSSL: You can use scripts for certificate generation:</p>
<div class="ulist">
<ul>
<li>
<p>Node.js</p>
</li>
<li>
<p>Powershell or Bash</p>
</li>
</ul>
</div>
</li>
<li>
<p>Device Identity Composition Engine (DICE) Enulator: DICE can be used for cryptographic device identity and attestation based on TLS protocol and X.509 client certificates.</p>
</li>
</ul>
</div>
</li>
<li>
<p><a href="https://learn.microsoft.com/en-us/azure/iot-hub/tutorial-x509-openssl" class="bare">https://learn.microsoft.com/en-us/azure/iot-hub/tutorial-x509-openssl</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_iot_device_access_control_to_dps"><a class="anchor" href="#_iot_device_access_control_to_dps"></a>IoT Device Access control to DPS</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>The DPS uses permissions to grant access to each endpoint.</p>
</li>
<li>
<p>Permissions limit the access to a service instance based on functionality.</p>
</li>
<li>
<p>For example, a backend app must include a token that contains security credentials along with every message it sends to the service.</p>
</li>
<li>
<p>You can grant permissions in the following ways:</p>
<div class="ulist">
<ul>
<li>
<p>Shared access authorization policies. Shared access policies can grant any combination of permissions.</p>
</li>
<li>
<p>A newly created provisioning service has the <code>provisioningserviceowner</code> policy set as the default policy. It is a policy with all permissions.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_authentication_2"><a class="anchor" href="#_authentication_2"></a>Authentication</h3>
<div class="ulist">
<ul>
<li>
<p>DPS grants access to endpoints by verifying a token against the shared access policies.</p>
</li>
<li>
<p>Security credentials, such as symmetric keys, are never sent over the wire.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_security_tokens_2"><a class="anchor" href="#_security_tokens_2"></a>Security tokens</h3>
<div class="ulist">
<ul>
<li>
<p>The DPS uses security tokens to authenticate services to avoid sending keys on the wire.</p>
</li>
<li>
<p>Security tokens are limited in time validity and scope.</p>
</li>
<li>
<p>DPS SDKs automatically generate tokens without requiring any special configuration.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_security_token_structure"><a class="anchor" href="#_security_token_structure"></a>Security Token Structure</h3>
<div class="ulist">
<ul>
<li>
<p>Use security tokens to grant time-bounded access for services to specific functionality in IoT Device Provisioning Service.</p>
</li>
<li>
<p>To get authorization to connect to the provisioning service, services must send security tokens signed with either a shared access or symmetric key.</p>
</li>
<li>
<p>A token signed with a shared access key grants access to all the functionality associated with the shared access policy permissions.</p>
</li>
<li>
<p>The security token has the following format:</p>
<div class="ulist">
<ul>
<li>
<p><code>SharedAccessSignature sig={signature}&amp;se={expiry}&amp;skn={policyName}&amp;sr={URL-encoded-resourceURI}</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_use_security_tokens_from_service_components"><a class="anchor" href="#_use_security_tokens_from_service_components"></a>Use security tokens from service components</h3>
<div class="ulist">
<ul>
<li>
<p>Service components can only generate security tokens using shared access policies granting the appropriate permissions.</p>
</li>
</ul>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Endpoint</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Functionality</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">{your-service}.azure-devices-provisioning.net/enrollments</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Provides device enrollment operations with the Device Provisioning Service.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">{your-service}.azure-devices-provisioning.net/enrollmentGroups</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Provides operations for managing device enrollment groups.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">{your-service}.azure-devices-provisioning.net/registrations/{id}</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Provides operations for retrieving and managing the status of device registrations.</p></td>
</tr>
</tbody>
</table>
<div class="ulist">
<ul>
<li>
<p>As an example, a service generated using a pre-created shared access policy named <code>enrollmentread</code> would create a token with the following parameters:</p>
<div class="ulist">
<ul>
<li>
<p>resource URI: <code>{mydps}.azure-devices-provisioning.net</code>,</p>
</li>
<li>
<p>signing key: one of the keys of the <code>enrollmentread</code> policy,</p>
</li>
<li>
<p>policy name: <code>enrollmentread</code>,</p>
</li>
<li>
<p>an expiration time</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>The result, which would grant access to read all enrollment records, would be:</p>
</div>
<div class="paragraph">
<p><code>SharedAccessSignature sr=mydps.azure-devices-
provisioning.net&amp;sig=JdyscqTpXdEJs49elIUCcohw2DlFDR3zfH5KqGJo4r4%3D&amp;se=1456973447&amp;skn=enrollmentread</code></p>
</div>
</div>
<div class="sect2">
<h3 id="_iot_device_provisioning_service"><a class="anchor" href="#_iot_device_provisioning_service"></a>IoT Device Provisioning Service</h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Permission</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Notes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ServiceConfig</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Grants access to change the service configurations. This permissions is used by backend cloud services.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">EnrollmentRead</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Grants read access to the device enrollments and enrollment groups. This permission is used by backend cloud services.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">EnrollmentWrite</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Grants write access to the device enrollments and enrollment groups. This permission is used by backend cloud services.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">RegistrationStatusRead</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Grants read access to the device registration status. This permission is used by backend cloud services.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">RegistrationStatusWrite</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Grants delete access to the device registration status. This permission is used by backend cloud services.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_iot_device_configure_verified_ca_certificates"><a class="anchor" href="#_iot_device_configure_verified_ca_certificates"></a>IoT Device Configure Verified CA Certificates</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>A verified X.509 Certificate Authority (CA) certificate is a CA certificate that has been uploaded and registered to your provisioning service and has gone through proof-of-possession with the service.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_proof_of_possession_process"><a class="anchor" href="#_proof_of_possession_process"></a>Proof-of-Possession Process</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Get a unique verification code generated by the provisioning service for your X.509 CA certificate. You can do this from the Azure portal.</p>
</li>
<li>
<p>Create an X.509 verification certificate with the verification code as its subject and sign the certificate with the private key associated with your X.509 certificate.</p>
</li>
<li>
<p>Upload the signed verification certificate to the service. The service validates the verification certificate using the public portion of the CA certificate to be verified, thus proving that you are in possession of the CA certificate&#8217;s private key.</p>
</li>
</ol>
</div>
<div class="ulist">
<ul>
<li>
<p>Verifying certificate ownership ensures the uploader of the certificate is in possession of the certificate&#8217;s private key.</p>
</li>
<li>
<p>Verification prevents a malicious actor sniffing your traffic from extracting an intermediate certificate and using that certificate to create an enrollment group in their own provisioning service, effectively hijacking your devices.</p>
</li>
<li>
<p>By proving ownership of the root or an intermediate certificate in a certificate chain, you are proving that you have permission to generate leaf certificates for the devices that will be registering as part of that enrollment group.</p>
</li>
<li>
<p>For this reason, the root or intermediate certificate configured in an enrollment group must either be a verified certificate or must roll up to a verified certificate in the certificate chain a device presents when it authenticates with the service.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_register_and_get_the_verification_code"><a class="anchor" href="#_register_and_get_the_verification_code"></a>Register and get the verification code</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In the Azure portal, navigate to your provisioning service and open Certificates from the left-hand menu.</p>
</li>
<li>
<p>Select Add to add a new certificate.</p>
</li>
<li>
<p>Enter a friendly display name for your certificate.</p>
</li>
<li>
<p>Browse to your .cer or .pem file that represents the public part of your X.509 certificate.</p>
</li>
<li>
<p>Select Upload.</p>
</li>
<li>
<p>Once you get a notification that your certificate is successfully uploaded, Select Save.</p>
</li>
<li>
<p>Select the certificate that you added in the previous step.</p>
</li>
<li>
<p>In Certificate Details, select Generate Verification code.</p>
</li>
<li>
<p>The provisioning service creates a verification code that you can use to validate the certificate ownership.</p>
</li>
<li>
<p>Copy the code to your clipboard.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_digitally_sign_the_verification_code_to_create_a_verification_certificate"><a class="anchor" href="#_digitally_sign_the_verification_code_to_create_a_verification_certificate"></a>Digitally sign the verification code to create a verification certificate</h3>
<div class="ulist">
<ul>
<li>
<p>You need to sign the Verification Code with the private key associated with your X.509 CA certificate, which generates a signature.</p>
</li>
<li>
<p>This process is known as Proof of possession and results in a signed verification certificate.</p>
</li>
<li>
<p>The Azure IoT Hub C SDK provides Powershell (Windows) and Bash (Linux) scripts to help you create CA and leaf certificates for development and to perform proof-of-possession using a verification code.</p>
</li>
<li>
<p>You download the files relevant to your system to a working folder and follow the instructions in the Managing CA certificates readme to perform proof-of-possession on a CA certificate.</p>
</li>
<li>
<p>The Azure IoT Hub C# SDK contains the Group Certificate Verification Sample, which you can use to do proof-of-possession.</p>
</li>
<li>
<p>The Powershell and Bash scripts provided in the documentation and SDKs rely on OpenSSL.</p>
</li>
<li>
<p>You may also use OpenSSL or other third-party tools to help you do proof-of-possession.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_upload_the_signed_verification_certificate"><a class="anchor" href="#_upload_the_signed_verification_certificate"></a>Upload the signed verification certificate</h3>
<div class="ulist">
<ul>
<li>
<p>Upload the resulting signature as a verification certificate to your provisioning service in the portal.</p>
</li>
<li>
<p>In Certificate Details on the Azure portal, use the File Explorer icon next to the Verification Certificate .pem or .cer file field to upload the signed verification certificate from your system.</p>
</li>
<li>
<p>Once the certificate is successfully uploaded, select Verify. The STATUS of your certificate changes to Verified in the Certificate Explorer list.</p>
</li>
<li>
<p>Select Refresh if it does not update automatically.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_iot_device_roll_certificates"><a class="anchor" href="#_iot_device_roll_certificates"></a>IoT Device - Roll Certificates</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>During the lifecycle of your IoT solution, you will need to roll certificates.</p>
</li>
<li>
<p>It could be because of a security breach or certificate expirations.</p>
</li>
<li>
<p>Rolling device certificates will involve updating the certificate stored on the device and the IoT hub.</p>
</li>
<li>
<p>The device can then reprovision itself with the IoT hub using normal autoprovisioning with the DPS.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_roll_the_certificate_on_the_device"><a class="anchor" href="#_roll_the_certificate_on_the_device"></a>Roll the certificate on the device</h3>
<div class="ulist">
<ul>
<li>
<p>Certificates on a device should always be stored in a safe place like a HSM.</p>
</li>
<li>
<p>If you are managing your own device certificates, make sure both old and new leaf certificates have the same Common Name (CN).</p>
</li>
<li>
<p>By having the same CN, the device can reprovision itself without creating a duplicate registration record.</p>
</li>
<li>
<p><a href="https://learn.microsoft.com/en-us/azure/iot-dps/how-to-roll-certificates" class="bare">https://learn.microsoft.com/en-us/azure/iot-dps/how-to-roll-certificates</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_iot_device_the_deprovisioning_process"><a class="anchor" href="#_iot_device_the_deprovisioning_process"></a>IoT Device - The Deprovisioning process</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>You may find it necessary to deprovision devices that were previously autoprovisioned through the DPS.</p>
</li>
<li>
<p>For example, a device may be sold or moved to a different IoT hub, or it may be lost, stolen, or otherwise compromised.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Deprovisioning a device involves two steps:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Disenroll the device from your provisioning service, to prevent future autoprovisioning.</p>
<div class="ulist">
<ul>
<li>
<p>To learn how to disenroll a device, see <a href="https://learn.microsoft.com/en-us/azure/iot-dps/how-to-revoke-device-access-portal" class="bare">https://learn.microsoft.com/en-us/azure/iot-dps/how-to-revoke-device-access-portal</a></p>
</li>
<li>
<p>To learn how to disenroll a device programmatically using one of the provisioning SDKs, see <a href="https://learn.microsoft.com/en-us/azure/iot-dps/quick-enroll-device-x509?pivots=programming-language-csharp" class="bare">https://learn.microsoft.com/en-us/azure/iot-dps/quick-enroll-device-x509?pivots=programming-language-csharp</a></p>
</li>
<li>
<p>Deregister the device from your IoT Hub, to prevent future communications and data transfer.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>The exact steps you take to deprovision a device depends on its attestation mechanism and its applicable enrollment entry with your provisioning service.</p>
</div>
<div class="paragraph">
<p>Deprovisioning enrollment groups requires you to consider two scenarios:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>To deprovision all of the devices that have been provisioned through an enrollment group:</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Disable the enrollment group to blocklist its signing certificate.</p>
</li>
<li>
<p>Use the list of provisioned devices for that enrollment group to disable or delete each device from the identity registry of its respective IoT hub</p>
</li>
<li>
<p>After disabling or deleting all devices from their respective IoT hubs, you can optionally delete the enrollment group.</p>
</li>
<li>
<p>Be aware, though, that, if you delete the enrollment group and there is an enabled enrollment group for a signing certificate higher up in the certificate chain of one or more of the devices, those devices can re-enroll.</p>
</li>
</ol>
</div>
</li>
<li>
<p>To deprovision a single device from an enrollment group:</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create a disabled individual enrollment for its leaf (device) certificate.</p>
</li>
<li>
<p>This revokes access to the provisioning service for that device while still permitting access for other devices that have the enrollment group&#8217;s signing certificate in their chain.</p>
</li>
<li>
<p>Do not delete the disabled individual enrollment for the device.</p>
</li>
<li>
<p>Doing so will allow the device to re-enroll through the enrollment group.</p>
</li>
<li>
<p>Use the list of provisioned devices for that enrollment group to find the IoT hub that the device was provisioned to and disable or delete it from theat hub&#8217;s identity registry.</p>
</li>
</ol>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_iot_device_manage_disenrollment"><a class="anchor" href="#_iot_device_manage_disenrollment"></a>IoT Device - Manage Disenrollment</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Enrollment in the DPS enables a device to be autoprovisioned.</p>
</li>
<li>
<p>A provisioned device is one that has been registered with IoT Hub.</p>
</li>
<li>
<p>This allows it to receive its initial device twin state and begin reporting telemetry data.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_blocklist_devices_by_using_an_individual_enrollment_entry"><a class="anchor" href="#_blocklist_devices_by_using_an_individual_enrollment_entry"></a>Blocklist devices by using an individual enrollment entry</h3>
<div class="ulist">
<ul>
<li>
<p>Individual enrollments apply to a single device.</p>
</li>
<li>
<p>It can use either X.509 certificates or SAS tokens as the attestation mechanism.</p>
</li>
<li>
<p>Devices that use SAS tokens as their attestation mechanism can be provisioned only through an individual enrollment.</p>
</li>
<li>
<p>To blocklist a device that has an individual enrollment, you can either disable or delete its enrollment entry.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To <strong>temporarily</strong> blocklist the device by disabling its enrollment entry:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Sign in to the Azure portal and select All resources from the left menu.</p>
</li>
<li>
<p>In the list of resources, select the provisioning service that you want to blocklist your device from.</p>
</li>
<li>
<p>In your provisioning service, select Manage enrollments, and then select the Individual Enrollments tab.</p>
</li>
<li>
<p>Select the enrollment entry for the device that you want to blocklist.</p>
</li>
<li>
<p>On your enrollment page, scroll to the bottom, and select Disable for the Enable entry switch, and then select Save.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>To <strong>permanently</strong> blocklist the device by deleting its enrollment entry:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Sign in to the Azure portal and select All resources from the left menu.</p>
</li>
<li>
<p>In the list of resources, select the provisioning service that you want to blocklist your device from.</p>
</li>
<li>
<p>In your provisioning service, select Manage enrollments, and then select the Individual Enrollments tab.</p>
</li>
<li>
<p>Select the check box next to the enrollment entry for the device that you want to blocklist.</p>
</li>
<li>
<p>Select Delete at the top of the window, and then select Yes to confirm that you want to remove the enrollment.</p>
</li>
<li>
<p>After you finish the procedure, you should see your entry removed from the list of individual enrollments.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_blocklist_an_x_509_intermediate_or_root_ca_certificate_by_using_an_enrollment_group"><a class="anchor" href="#_blocklist_an_x_509_intermediate_or_root_ca_certificate_by_using_an_enrollment_group"></a>Blocklist an X.509 intermediate or root CA certificate by using an enrollment group.</h3>
<div class="ulist">
<ul>
<li>
<p>X.509 certificates are typically arranged in a certificate chain of trust.</p>
</li>
<li>
<p>If a certificate at any stage in a chain becomes compromised, trust is broken.</p>
</li>
<li>
<p>The certificate must be blocklisted to prevent Device Provisioning Service from provisioning devices downstream in any chain that contains that certificate.</p>
</li>
<li>
<p>An enrollment group is an entry for devices that share a common attestation mechanism of X.509 certificates signed by the same intermediate or root CA.</p>
</li>
<li>
<p>The enrollment group entry is configured with the X.509 certificate associated with the intermediate or root CA.</p>
</li>
<li>
<p>The entry is also configured with any configuration values, such as twin state and IoT hub connection, that are shared by devices with that certificate in their certificate chain.</p>
</li>
<li>
<p>To blocklist the certificate, you can either disable or delete its enrollment group.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_blocklist_specific_devices_in_an_enrollment_group"><a class="anchor" href="#_blocklist_specific_devices_in_an_enrollment_group"></a>Blocklist specific devices in an enrollment group</h3>
<div class="ulist">
<ul>
<li>
<p>Devices that implement the X.509 attestation mechanism use the device&#8217;s certificate chain and private key to authenticate.</p>
</li>
<li>
<p>When a device connects and authenticates with DPS, the service first looks for an individual enrollment that matches the device&#8217;s credentials.</p>
</li>
<li>
<p>The service then searches enrollment groups to determine whether the device can be provisioned.</p>
</li>
<li>
<p>If the service finds a disabled individual enrollment for the device, it prevents the device from connecting.</p>
</li>
<li>
<p>The service prevents the connection even if an enabled enrollment group for an intermediate or root CA in the device&#8217;s certificate chain exists.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_iot_hub_how_to_provision_for_multitenancy"><a class="anchor" href="#_iot_hub_how_to_provision_for_multitenancy"></a>IoT Hub - How to provision for multitenancy</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>The allocation policies defined by the provisioning service support various allocation scenarios.</p>
<div class="ulist">
<ul>
<li>
<p>Geolocation/GeoLatency: This policy causes the DPS to evaluate device latency and determine the closest IoT hub out of the group of IoT hubs.</p>
</li>
<li>
<p>Multi-tenancy: The solution may require all devices for a particular tenant to communicate with a specific group of IoT hubs.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="ulist">
<ul>
<li>
<p>Provisioning devices for the multitenant scenario across regions, involves the following:</p>
<div class="ulist">
<ul>
<li>
<p>Two (or more) regional IoT hubs.</p>
</li>
<li>
<p>An enrollment group that uses a multitenant enrollment and specifies assigning devices based on lowest latency.</p>
</li>
<li>
<p>Multiple devices provisioned in each region.</p>
</li>
</ul>
</div>
</li>
<li>
<p>With this configuration in place, you will see that devices in each region are provisioned to the same tenant in the closest region.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_iot_hub_common_message_format"><a class="anchor" href="#_iot_hub_common_message_format"></a>IoT Hub - Common Message Format</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>To support seamleass interoperability across protocols, IoT Hub defines a common message format for all device-facing protocols.</p>
</li>
<li>
<p>This message format is used for both device-to-cloud and cloud-to-device messages.</p>
</li>
<li>
<p>IoT Hub implements device-to-cloud messaging using a streaming messaging pattern.</p>
</li>
<li>
<p>IoT Hub&#8217;s device-to-cloud messages are more like Event Hubs events than Service Bus messages in that there is a high volume of events passing through the service that can be read by multiple readers.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>An IoT Hub message consists of:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A predetermined set of <em>system properties</em> as listed below.</p>
</li>
<li>
<p>A set of <em>application properties</em>. A dictionary of string properties that the application can define and access, without needing to deserialize the message body. IoT Hub never modifies these properties.</p>
</li>
<li>
<p>An opaque binary body.</p>
</li>
</ul>
</div>
<div class="ulist">
<ul>
<li>
<p>Property name and values can only contain ASCII alphanumeric characters.</p>
</li>
<li>
<p><code>{'!', '#', '$', '%, '&amp;', ''', '*', '+', '-', '.', '^', '_', '&#8217;, '|', '~'}</code> are also allowed.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Device-to-cloud messaging with IoT Hub has the following characteristics:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Device-to-cloud messages are durable and retained in an IoT Hub&#8217;s default messages/events endpoint for up to seven days.</p>
</li>
<li>
<p>Device-to-cloud messages can be at most 256 KB, and can be grouped in batches to optimize sends. Batches can be at most 256 KB.</p>
</li>
<li>
<p>IoT Hub does not allow arbitrary partitioning. Device-to-cloud messages are partitioned based on their originating <strong>deviceID</strong>.</p>
</li>
<li>
<p>IoT Hub enables per-device authentication and access control.</p>
</li>
<li>
<p>You can stamp messages with information that goes into the application properties.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_system_properties_of_d2c_iot_hub_messages"><a class="anchor" href="#_system_properties_of_d2c_iot_hub_messages"></a>System properties of D2C IoT hub messages</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>message-id</strong></p>
<div class="paragraph">
<p>A user settable identifier for the message used for request-reply patterns.<br>
A case-sensitive string (up to 128 characters long) of ASCII 7-bit alphanumeric characters.<br>
Other characters allowed: ` {'-', ':', '.', '+', '%', '_', '#', '*', '?', '!', '(', ')', ',', '=', '@', ';', '$', '''}`</p>
</div>
<div class="paragraph">
<p>It is user settable.</p>
</div>
<div class="paragraph">
<p>The keyword for routing query is <em>messageId</em>.</p>
</div>
</li>
<li>
<p><strong>iothub-enqueuedtime</strong></p>
<div class="paragraph">
<p>Date and time the Device-to-Cloud message was received by IoT Hub.</p>
</div>
<div class="paragraph">
<p>It is not user settable.</p>
</div>
<div class="paragraph">
<p>The keyword for routing query is <em>enqueuedTime</em>.</p>
</div>
</li>
<li>
<p><strong>user-id</strong></p>
<div class="paragraph">
<p>An ID used to specify the origin of messages.<br>
When messages are generated by IoT Hub, it is set to <code>{iot hub name}</code>.</p>
</div>
<div class="paragraph">
<p>It is user settable.</p>
</div>
<div class="paragraph">
<p>The keyword for routing query is <em>userId</em>.</p>
</div>
</li>
<li>
<p><strong>iothub-connection-device-id</strong></p>
<div class="paragraph">
<p>An ID set by IoT Hub on device-to-cloud messages.<br>
It contains the <strong>deviceId</strong> of the device that sent the message.</p>
</div>
<div class="paragraph">
<p>It is not user settable.</p>
</div>
<div class="paragraph">
<p>The keyword for routing query is <em>connectionDeviceId</em>.</p>
</div>
</li>
<li>
<p><strong>iothub-connection-module-id</strong></p>
<div class="paragraph">
<p>And ID set by IoT Hub on device-to-cloud messages.<br>
It contains the <strong>moduleId</strong> of the device that sent the message.</p>
</div>
<div class="paragraph">
<p>It is not user settable.</p>
</div>
<div class="paragraph">
<p>The keyword for routing query is <em>connectionModuleId</em>.</p>
</div>
</li>
<li>
<p><strong>iothub-connection-auth-generation-id</strong></p>
<div class="paragraph">
<p>An ID set by IoT Hub on device-to-cloud messages.<br>
It contains the <strong>connectionDeviceGenerationId</strong> of the device that sent the message.</p>
</div>
<div class="paragraph">
<p>It is not user settable.</p>
</div>
<div class="paragraph">
<p>The keyword for routing query is <em>connectionDeviceGenerationId</em>.</p>
</div>
</li>
<li>
<p><strong>iothub-connection-auth-method</strong></p>
<div class="paragraph">
<p>An authentication method set by IoT Hub on device-to-cloud messages.<br>
This property contains information about the authentication method used to authenticate the device sending the message.</p>
</div>
<div class="paragraph">
<p>It is not user settable.</p>
</div>
<div class="paragraph">
<p>The keyword for routing query is <em>connectionAuthMethod</em>.</p>
</div>
</li>
<li>
<p><strong>dt-dataschema</strong></p>
<div class="paragraph">
<p>This value is set by IoT hub on device-to-cloud messages.<br>
It contains the device model ID set in the device connection.</p>
</div>
<div class="paragraph">
<p>It is not user settable.</p>
</div>
<div class="paragraph">
<p>The keyword for routing query is <em>$dt-dataschema</em>.</p>
</div>
</li>
<li>
<p><strong>dt-subject</strong></p>
<div class="paragraph">
<p>The name of the component that is sending the device-to-cloud messages.</p>
</div>
<div class="paragraph">
<p>It is user settable.</p>
</div>
<div class="paragraph">
<p>The keyword for routing query is <em>$dt-subject</em>.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_system_properties_of_c2d_iot_hub_messages"><a class="anchor" href="#_system_properties_of_c2d_iot_hub_messages"></a>System Properties of C2D IoT hub messages</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>message-id</strong></p>
<div class="paragraph">
<p>A user settable identifier for the message used for request-reply patterns.<br>
A case-sensitive string (up to 128 characters long) of ASCII 7-bit alphanumeric characters.<br>
Other characters allowed: ` {'-', ':', '.', '+', '%', '_', '#', '*', '?', '!', '(', ')', ',', '=', '@', ';', '$', '''}`</p>
</div>
<div class="paragraph">
<p>It is user settable.</p>
</div>
</li>
<li>
<p><strong>sequence-number</strong></p>
<div class="paragraph">
<p>A number (unique per device-queue) assigned by IoT hub to each cloud-to-device message.</p>
</div>
<div class="paragraph">
<p>It is not user settable.</p>
</div>
</li>
<li>
<p><strong>to</strong></p>
<div class="paragraph">
<p>A destination specified in Cloud-to-Device messages.</p>
</div>
<div class="paragraph">
<p>It is not user settable.</p>
</div>
</li>
<li>
<p><strong>absolute expiry time</strong></p>
<div class="paragraph">
<p>Date and time of message expiration</p>
</div>
<div class="paragraph">
<p>It is user settable.</p>
</div>
</li>
<li>
<p><strong>correlation-id</strong></p>
<div class="paragraph">
<p>A string property in a response message that typically contains the MessageId of the request, in request-reply patterns.</p>
</div>
<div class="paragraph">
<p>It is user settable.</p>
</div>
</li>
<li>
<p><strong>user-id</strong></p>
<div class="paragraph">
<p>An ID used to specify the origin of messages.<br>
When messages are generated by IoT Hub, it is set to <code>{iot hub name}</code></p>
</div>
<div class="paragraph">
<p>It is use settable.</p>
</div>
</li>
<li>
<p><strong>iothub-ack</strong></p>
<div class="paragraph">
<p>A feedback message generator.</p>
</div>
<div class="paragraph">
<p>This property is used in cloud-to-device messages to request IoT Hub to generate feedback messages as a result of the consumption of the message by the device.</p>
</div>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>Possible values:</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
none(default)
</td>
<td class="hdlist2">
<p>no feedback message is generated.<br></p>
</td>
</tr>
<tr>
<td class="hdlist1">
positive
</td>
<td class="hdlist2">
<p>receive a feedback message if the message was completed.<br></p>
</td>
</tr>
<tr>
<td class="hdlist1">
negative
</td>
<td class="hdlist2">
<p>receive a feedback message if the message expired without being completed by the device.<br></p>
</td>
</tr>
<tr>
<td class="hdlist1">
full
</td>
<td class="hdlist2">
<p>both positive and negative.</p>
</td>
</tr>
</table>
</div>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_message_size"><a class="anchor" href="#_message_size"></a>Message size</h3>
<div class="paragraph">
<p>IoT Hub measures message size in a protocol-agnostic way, considering only the actual payload.</p>
</div>
<div class="paragraph">
<p>The size in bytes is calculated as the sum of the following values:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The body size in bytes.</p>
</li>
<li>
<p>The size in bytes of all the values of the message system properties.</p>
</li>
<li>
<p>The size in bytes of all user property names and values.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Property names and values are limited to ASCII characters, so the length of the strings equals the size in bytes.</p>
</div>
</div>
<div class="sect2">
<h3 id="_anti_spoofing_properties"><a class="anchor" href="#_anti_spoofing_properties"></a>Anti-spoofing properties</h3>
<div class="paragraph">
<p>To avoid device spoofing in device-to-cloud messages, IoT Hub stamps all messages with the following properties:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>iothub-connection-device-id</p>
</li>
<li>
<p>iothub-connection-auth-generation-id</p>
</li>
<li>
<p>iothub-connection-auth-method</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The first two contain the <strong>deviceId</strong> and <strong>generationId</strong> of the originating device (device identity properties).</p>
</div>
<div class="paragraph">
<p>The iothub-connection-auth-method property contains a json serialized object:-</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  "scope": "{ hub | device }",
  "type": "{ symkey | sas | x509 }",
  "issuer": "iothub"
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_iot_hub_message_routing"><a class="anchor" href="#_iot_hub_message_routing"></a>IoT Hub - Message Routing</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>IoT Hub Message Routing enables users to rout device-to-cloud messages to service-facing endpoints.</p>
</li>
<li>
<p>Routing also provides a querying capability to filter the data before routing it to the endpoints.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_routing_endpoints"><a class="anchor" href="#_routing_endpoints"></a>Routing endpoints</h3>
<div class="ulist">
<ul>
<li>
<p>An IoT hub has a default built-in messaging endpoint (messages/events).</p>
</li>
<li>
<p>Custom endpoints can be configured that link IoT hub to other services in your subscription.</p>
</li>
<li>
<p>IoT Hub currently supports the following custom endpoints:</p>
<div class="ulist">
<ul>
<li>
<p>Azure Storage containers</p>
</li>
<li>
<p>Event Hubs</p>
</li>
<li>
<p>Service Bus Queues</p>
</li>
<li>
<p>Service Bus Topics</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="ulist">
<ul>
<li>
<p>There are two storage services IoT hub can route messages to: Azure Blob Storage and Azure Data Lake Storage Gen2.</p>
</li>
<li>
<p>Both of these use blobs for their storage.</p>
</li>
<li>
<p>Service Bus Queues and Service Bus Topics that have Sessions or Duplicate Detection enabled are not supported as custom endpoints.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_routing_queries"><a class="anchor" href="#_routing_queries"></a>Routing queries</h3>
<div class="ulist">
<ul>
<li>
<p>A single message may match the condition on multiple routing queries.</p>
</li>
<li>
<p>The IoT hub delivers the message to the endpoint associated with each matched query.</p>
</li>
<li>
<p>IoT hub automatically deduplicates message delivery.</p>
</li>
<li>
<p>So if a message matches multiple queries that have the same destination, it is only written once to that destination.</p>
</li>
<li>
<p>When you route message data to custom endpoints, messages are only delivered to the built-in endpoint if they do not match any query.</p>
</li>
<li>
<p>To deliver messages to both the built-in endpoint and to a custom endpoint, add a route that sends messages to the built-in events endpoint.</p>
</li>
</ul>
</div>
<div class="ulist">
<ul>
<li>
<p>Each routing query you configure has the following properties:</p>
</li>
</ul>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
Name
</td>
<td class="hdlist2">
<p>The unique name that identifies the query.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
Source
</td>
<td class="hdlist2">
<p>The origin of the data stream to be acted upon. For example, device telemetry.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
Condition
</td>
<td class="hdlist2">
<p>The query expression for the routing query that is run against the following to determine if it is a match for the endpoint:</p>
<div class="ulist">
<ul>
<li>
<p>message application properties</p>
</li>
<li>
<p>system properties</p>
</li>
<li>
<p>message body</p>
</li>
<li>
<p>device twin tags</p>
</li>
<li>
<p>device twin properties</p>
</li>
</ul>
</div>
</td>
</tr>
<tr>
<td class="hdlist1">
Endpoint
</td>
<td class="hdlist2">
<div class="ulist">
<ul>
<li>
<p>The name of the endpoint where IoT hub sends messages that match the query.</p>
</li>
<li>
<p>We recommend that you choose an endpoint in the same region as your IoT hub.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_iot_hub_built_in_endpoint"><a class="anchor" href="#_iot_hub_built_in_endpoint"></a>IoT Hub built-in endpoint</h3>
<div class="ulist">
<ul>
<li>
<p>By default, messages are routed to the built-in service-facing endpoint which is compatible with Event Hubs.</p>
</li>
<li>
<p>This endpoint is currently only exposed using the AMQP protocol on port 5671 and AMQP over WebSockets on port 443.</p>
</li>
<li>
<p>An IoT hub exposes the following properties to enable you to control the built-in endpoint.</p>
<div class="dlist">
<dl>
<dt class="hdlist1">Partition count</dt>
<dd>
<p>Set this property at creation to define the number of partitions for device-to-cloud event ingestion.</p>
</dd>
<dt class="hdlist1">Retention time</dt>
<dd>
<p>This property specifies how long in days messages are retained by IoT Hub. The default is one day, but it can be increased to seven days.</p>
</dd>
</dl>
</div>
</li>
<li>
<p>IoT Hub enables you to manage consumer groups on the built-in device-to-cloud receive endpoint.</p>
</li>
<li>
<p>You can have up to 20 consumer groups for each IoT Hub.</p>
</li>
<li>
<p>If you are using message routing and the fallback route is enabled, all messages that do not match a query on any route go to the built-in endpoint.</p>
</li>
<li>
<p>If you disable this fallback route, messages that don&#8217;t match any query are dropped.</p>
</li>
<li>
<p>Retention time can modified programmatically or through the Azure portal.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_reading_from_the_built_in_endpoint"><a class="anchor" href="#_reading_from_the_built_in_endpoint"></a>Reading from the Built-in endpoint</h3>
<div class="ulist">
<ul>
<li>
<p>IoT Hub exposes the messages/events built-in endpoint for your back-end services to read the device-to-cloud messages.</p>
</li>
<li>
<p>This endpoint is Event Hubs-compatible, which enables you to use any of the mechanisms the Event Hubs service supports for reading messages.</p>
</li>
<li>
<p>For services that are aware of IoT Hub, you can use IoT hub service connection string to connect to the built-in endpoint.</p>
</li>
<li>
<p>For services that are not aware of IoT Hub, you need an Event Hubs-compatible endpoint and Event Hubs-compatible name.</p>
</li>
<li>
<p>You can retrieve these values from IoT hub service in the Azure portal by opening the <strong>Built-in endpoints</strong> blade.</p>
</li>
<li>
<p>You can use any shared access policy that has the ServiceConnect permissions to connect to the specified Event Hubs.</p>
</li>
<li>
<p>The following Azure products are aware of IoT Hub and you can easily create a service connection to them:</p>
<div class="ulist">
<ul>
<li>
<p>Azure Functions.</p>
</li>
<li>
<p>Azure Stream Analytics.</p>
</li>
<li>
<p>Time Series Insights.</p>
</li>
<li>
<p>Apache Storm spout.</p>
</li>
<li>
<p>Apache Spark integration.</p>
</li>
<li>
<p>Azure Databricks.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_routing_to_multiple_endpoints"><a class="anchor" href="#_routing_to_multiple_endpoints"></a>Routing to multiple endpoints</h3>
<div class="ulist">
<ul>
<li>
<p>Message routing can be used for:</p>
<div class="ulist">
<ul>
<li>
<p>Sending device telemetry messages and events, namely device lifecycle events and device twin change events, to the built-in-endpoint and custom endpoints.</p>
</li>
<li>
<p>Filtering data before routing it to various endpoints by applying queries.</p>
</li>
<li>
<p>Message routing allows you to query on the message properties and message body as well as device twin tags and device twin properties.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="ulist">
<ul>
<li>
<p>IoT Hub needs write access to these service endpoints for message routing to work.</p>
</li>
<li>
<p>If you configure your endpoints through the Azure portal, the necessary permissions are added for you.</p>
</li>
<li>
<p>Make sure you configure your services to support the expected throughput.</p>
</li>
<li>
<p>For example, if you are using Event Hubs as a custom endpoint, you must configure the throughput units for that Event Hubs so it handle the ingress of events from IoT Hub.</p>
</li>
<li>
<p>Similarly, when using a Service Bus Queue as an endpoint, you must configure the maximum size to ensure the queue can hold all the data ingressed.</p>
</li>
<li>
<p>You many need to monitor your endpoints and make any necessary adjustments for the actual load.</p>
</li>
</ul>
</div>
<div class="ulist">
<ul>
<li>
<p>If a message matches multiple routes that point to the same endpoint, IoT Hub delivers the message to that endpoint only once.</p>
</li>
<li>
<p>You do not need to configure deduplication on your Service Bus queue or topic.</p>
</li>
<li>
<p>In partitioned queues, partition affinity guarantees message ordering.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_custom_endpoint"><a class="anchor" href="#_custom_endpoint"></a>Custom endpoint</h3>
<div class="ulist">
<ul>
<li>
<p>IoT hub supports Azure Storage containers, Event Hubs, Service Bus queues and Service Bus topics as custom endpoint.</p>
<div class="ulist">
<ul>
<li>
<p>Azure Storage</p>
<div class="ulist">
<ul>
<li>
<p>These are two storage services IoT Hub can route messages to&#8201;&#8212;&#8201;Azure Blob Storage and Azure Data Lake Storage Gen2 accounts.</p>
</li>
<li>
<p>Both of these use blobs for their storage.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Event Hubs</p>
<div class="ulist">
<ul>
<li>
<p>Event Hubs is a service that processes large amounts of event data (telemetry) from devices and applications.</p>
</li>
<li>
<p>After you collect data into Event Hubs, you can store the data using a storage cluster or transform it using a real-time analytics provider</p>
</li>
</ul>
</div>
</li>
<li>
<p>Service Bus Queues and Service Bus Topics</p>
<div class="ulist">
<ul>
<li>
<p>Service Bus Queues and Topics must not have Sessions or Duplicate Detection enabled. If either of those options are enabled, the endpoint appears as Unreachable in the Azure portal.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_fallback_route"><a class="anchor" href="#_fallback_route"></a>Fallback route</h3>
<div class="ulist">
<ul>
<li>
<p>The fallback route sends all the messages that don&#8217;t satisfy query conditions on any of the existing routes to the built-in endpoint (message/events) that is compatible with Event Hubs.</p>
</li>
<li>
<p>If message routing is turned on, you can enable the fallback route capability.</p>
</li>
<li>
<p>Once a route is created, data stops flowing to the built-in endpoint, unless a route is created to that endpoint.</p>
</li>
<li>
<p>If there are no routes to the built-in-endpoint and a fallback route is enabled, only messages that don&#8217;t match any query conditions on routes will be sent to the built-in-endpoint.</p>
</li>
<li>
<p>Also, if all existing routes are deleted, fallback route must be enabled to receive all data the built-in-endpoint.</p>
</li>
<li>
<p>You can enable/disable the fallback route in the Azure portal &#8594; Message Routing blade.</p>
</li>
<li>
<p>You can also use Azure Resource Manager for FallbackRouteProperties to use a custom endpoint for fallback route.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_non_telemetry_events"><a class="anchor" href="#_non_telemetry_events"></a>Non-telemetry events</h3>
<div class="ulist">
<ul>
<li>
<p>In additon to device telemetry, message routing also enables sending device twin change events, device lifecycle events, and digital twin change events.</p>
</li>
<li>
<p>For example, if a route is created with data source set to device twin change events, IoT Hub sends messages to the endpoint that contain the change in the device twin.</p>
</li>
<li>
<p>Similarly, if a route is created with data source set to device lifecycle events, IoT hub send a message indicating whether the device was deleted or created.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_latency"><a class="anchor" href="#_latency"></a>Latency</h3>
<div class="ulist">
<ul>
<li>
<p>When you route device-to-cloud telemetry messages using built-in endpoints, there is a slight increase in the end-to-end latency after the creation of the first route.</p>
</li>
<li>
<p>In most cases, the average increase in latency is less than 500ms.</p>
</li>
<li>
<p>You can monitor the latency using <code>Routing: message latency for messages/events</code> or <code>d2c.endpoints.latency.builtIn.events</code> IoT Hub metric.</p>
</li>
<li>
<p>Creating or deleting any route after the first one does not impact the end-to-end latency.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_iot_hub_monitoring_and_troubleshooting"><a class="anchor" href="#_iot_hub_monitoring_and_troubleshooting"></a>IoT Hub - Monitoring and Troubleshooting</h3>
<div class="ulist">
<ul>
<li>
<p><a href="https://learn.microsoft.com/en-us/azure/iot-hub/monitor-iot-hub">IoT Hub metrics</a> lists all the metrics that are enabled by default for your IoT Hub.</p>
</li>
<li>
<p>The Rest Api <a href="https://learn.microsoft.com/en-us/rest/api/iothub/iot-hub-resource/get-endpoint-health?tabs=HTTP">Get Endpoint Health</a> can be used to get the health status of the endpoints.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_iot_hub_message_routing_query_syntax"><a class="anchor" href="#_iot_hub_message_routing_query_syntax"></a>IoT Hub - Message Routing Query Syntax</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Message routing allows you to query on the message properties and message body as well as device twin tags and device twin properties.</p>
</li>
<li>
<p>If the message body is not JSON, message routing can still route the message, but queries cannot be applied to the message body.</p>
</li>
<li>
<p>Queries are boolean expression where a Boolean true makes the query succeed or fail.</p>
</li>
<li>
<p>If the expression evaluates to null or undefined, it is treated as false and an error will be generated in diagnostic logs if there is a routing failure.</p>
</li>
<li>
<p>The query syntax must be correct for the route to be saved and evaluated.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_message_properties_based_routing"><a class="anchor" href="#_message_properties_based_routing"></a>Message properties based routing</h3>
<div class="ulist">
<ul>
<li>
<p>The IoT Hub defines a common format for all device-to-cloud messaging for interoperability across protocols.</p>
</li>
<li>
<p>IoT Hub assumes the following JSON representation of the message.</p>
</li>
<li>
<p>System properties are added for all users and identify content of the message.</p>
</li>
<li>
<p>Users can selectively add appplication properties to the message.</p>
</li>
<li>
<p>IoT Hub device-to-cloud messaging is not case-sensitive.</p>
</li>
<li>
<p>If you have multiple properties with the same name, IoT Hub will only send one of the properties.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  "message": {
    "systemProperties": {
      "contentType": "application/json",
      "contentEncoding": "UTF-8",
      "iothub-message-source": "deviceMessages",
      "iothub-enqueuedtime": "2017-05-08T18:55:31.8514657Z"
    },
    "appProperties": {
      "processingPath": "{cold | warm | hot}",
      "verbose": "{true, false}",
      "severity": 1-5,
      "testDevice": "{true | false}"
    },
    "body": "{\"Weather\":{\"Temperature\":50}}"
  }
}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>System properties</strong> help identify contents and source of the messages.</p>
</li>
<li>
<p><strong>Application properties</strong> are user-defined strings that can be added to the message. These fields are optional.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_query_expressions"><a class="anchor" href="#_query_expressions"></a>Query expressions</h4>
<div class="ulist">
<ul>
<li>
<p>A query on message system properties needs to be prefixed with the <code>$</code> symbol.</p>
</li>
<li>
<p>Queries on application properties are accessed with their name and should not be prefixed with the <code>$</code> symbol.</p>
</li>
<li>
<p>If an application property name begins with <code>$</code>, then IoT Hub will search for it in the system properties, and if it is not found, then it will look in the application properties.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To query on system property contentEncoding:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">$contentEncoding = 'UTF-8'</code></pre>
</div>
</div>
<div class="paragraph">
<p>To query on application property processingPath:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">processingPath = 'hot'</code></pre>
</div>
</div>
<div class="paragraph">
<p>To combine these queries, you can use Boolean expressions and functions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">$contentEncoding = 'UTF-8' AND processingPath = 'hot'</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_message_body_based_routing"><a class="anchor" href="#_message_body_based_routing"></a>Message body based routing</h3>
<div class="ulist">
<ul>
<li>
<p>To enable querying on message body, the message should be a JSON encoded in either UTF-8, UTF-16 or UTF-32.</p>
</li>
<li>
<p>The <code>contentType</code> must be set to <code>application/JSON</code> and <code>contentEncoding</code> to one of the supported UTF encodings in the system properties.</p>
</li>
<li>
<p>If these properties are not specified, IoT Hub will not evaluate the query expression on the message body.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_query_expressions_2"><a class="anchor" href="#_query_expressions_2"></a>Query expressions</h4>
<div class="ulist">
<ul>
<li>
<p>A query on the message body needs to be prefixed with the $body.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Following are all valid query expressions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">$body.Weather.HistoricalData[0].Month = 'Feb'</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">$body.Weather.Temperature = 50 AND $body.Weather.IsEnabled</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">length($body.Weather.Location.State) = 2</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">$body.Weather.Temperature = 50 AND processingPath = 'hot'</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_device_twin_based_routing"><a class="anchor" href="#_device_twin_based_routing"></a>Device Twin based routing</h3>
<div class="ulist">
<ul>
<li>
<p>Message routing enables you to query on Device Twin tags and properties, which are JSON objects.</p>
</li>
<li>
<p>Querying on module twin is not supported.</p>
</li>
<li>
<p>A sample of Device Twin tags and properties is shown below:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
    "tags": {
        "deploymentLocation": {
            "building": "43",
            "floor": "1"
        }
    },
    "properties": {
        "desired": {
            "telemetryConfig": {
                "sendFrequency": "5m"
            },
            "$metadata" : {...},
            "$version": 1
        },
        "reported": {
            "telemetryConfig": {
                "sendFrequency": "5m",
                "status": "success"
            },
            "batteryLevel": 55,
            "$metadata" : {...},
            "$version": 4
        }
    }
}</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_query_expressions_3"><a class="anchor" href="#_query_expressions_3"></a>Query expressions</h4>
<div class="ulist">
<ul>
<li>
<p>A query on device twin properties needs to be prefixed with the $twin.</p>
</li>
<li>
<p>Use unique names in tags and properties as the query is not case-sensitive.</p>
</li>
<li>
<p>Refrain from using twin, $twin, body, or $bosy, as a property names.</p>
</li>
<li>
<p>Following are all valid query expressions:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">$twin.properties.desired.telemetryConfig.sendFrequency = '5m'</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">$body.Weather.Temperature = 50 AND $twin.properties.desired.telemetryConfig.sendFrequency = '5m'</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">$twin.tags.deploymentLocation.floor = 1</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_iot_device_message_processing_options_and_constraints"><a class="anchor" href="#_iot_device_message_processing_options_and_constraints"></a>IoT Device Message processing options and constraints</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_message_enrichments"><a class="anchor" href="#_message_enrichments"></a>Message Enrichments</h3>
<div class="ulist">
<ul>
<li>
<p>Message enrichment is the ability of the IoT Hub to stamp messages with additional information before the messages are sent to the designated endpoint.</p>
</li>
<li>
<p>One reason to use message enrichments is to include data that can be used to simplify downstream processing.</p>
</li>
<li>
<p>For example, enriching device telemetry messages with a device twin tag can reduce load on customers to make device twin API calls for this information.</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="https://learn.microsoft.com/en-us/training/wwl-azure/consider-message-processing-options-constraints/media/m04-l01-message-enrichments-flow-804be88e.png" alt="m04 l01 message enrichments flow 804be88e">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>A message enrichment has three key elements:</p>
<div class="ulist">
<ul>
<li>
<p>Enrichment name or key</p>
</li>
<li>
<p>A value</p>
</li>
<li>
<p>One or more endpoints for which the enrichment should be applied.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="ulist">
<ul>
<li>
<p>The key is a string.</p>
</li>
<li>
<p>A key can only contain alphanumeric characters or these special characters: hyphen(-), underscore (_), and period (.).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The value can be any of the following examples:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Any static string.</p>
</li>
<li>
<p>The name of the IoT hub sending the message. This value is $iothubname.</p>
</li>
<li>
<p>Information from the device twin, such as its path. Example would <code>$twin.tags.field</code> and <code>$twin.tags.latitude</code>.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>At this time, only <code>$iothubname</code>, <code>$twin.tags</code>, <code>$twin.properties.desired</code>, and <code>$twin.properties.reported</code> are supported variables for message enrichment.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p>Message enrichments are added as application properties to messages sent to chosen endpoint(s).</p>
</li>
<li>
<p>Enrichments are applied per endpoint.</p>
</li>
<li>
<p>If you specify five enrichments to be stamped for a specific endpoint, all messages going to that endpoint are stamped with the same five enrichments.</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Limitations</div>
<ul>
<li>
<p>You can add up to 10 enrichments per IoT Hub. In the case of the free tier, only 2 enrichments are allowed.</p>
</li>
<li>
<p>If you are applying an enrichment with a value set to a tag or property in the device twin, the value will be stamped as a string value.</p>
</li>
<li>
<p>For example, if an enrichment value is set to <code>$twin.tags.field</code>, the messages will be stamped with the string &#8220;$twin.tags.field&#8221; rather than the value of that field from the twin.</p>
</li>
<li>
<p>This happens in the following cases:</p>
<div class="ulist">
<ul>
<li>
<p>Your IoT Hub is in the basic tier. Basic tier IoT hubs do not support device twins.</p>
</li>
<li>
<p>Your IoT Hub is in the Standard tier, but the device sending the message has no device twin.</p>
</li>
<li>
<p>Your IoT Hub is in the standared tier, but the device twin path used for the value of the enrichment does not exist.</p>
<div class="ulist">
<ul>
<li>
<p>For example, if the enrichment value is set to <code>$twin.tags.location</code>, and the device twin does not have a <code>location</code> property under <code>tags</code>, the message is stamped with the string <code>$twin.tags.location</code>.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Updates to a device twin can take up to five minutes to be reflected in the corresponding enrichment value.</p>
</li>
<li>
<p>The total message size, including the enrichments, can&#8217;t exceed 256KB.</p>
<div class="ulist">
<ul>
<li>
<p>If the message size exceeds 256 KB, the IoT Hub will drop the message.</p>
</li>
<li>
<p>You can use IoT Hub metrics to identify and debug errors when messages are dropped. For example, you can monitor <code>d2d.telemetry.egress.invalid</code>.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Message enrichments don&#8217;t apply to digital twin change events.</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Pricing</div>
<ul>
<li>
<p>Message enrichments are available at no extra charge.</p>
</li>
<li>
<p>Currently, you are charged when you send a message to an IoT hub.</p>
</li>
<li>
<p>You are only charged once for that message, even if the message goes to multiple endpoints.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_iot_hub_quotas_and_throttling"><a class="anchor" href="#_iot_hub_quotas_and_throttling"></a>IoT Hub quotas and throttling</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Each Azure subscription can have at most 50 IoT hubs, and at most one Free hub.</p>
</li>
<li>
<p>Each IoT hub is provisioned with one or more units in a specific tier.</p>
</li>
<li>
<p>The tier and number of units determine the maximum daily quota of messages that you send</p>
</li>
<li>
<p>The message size used to calculate the daily quota is 0.5 KB for a free tier hub and 4 KB for all other tiers.</p>
</li>
<li>
<p>The tier also determines the throttling limits that IoT Hub enforces on all operations.</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Operation throttles</div>
<ul>
<li>
<p>Operation throttles are rate limitations that are applied in minute ranges and are intended to prevent abuse.</p>
</li>
<li>
<p>They are also subject to traffic shaping.</p>
</li>
<li>
<p>Check this link to get the details of the <a href="https://learn.microsoft.com/en-us/training/modules/consider-message-processing-options-constraints/4-iot-hub-quotas-throttle">throttles</a></p>
</li>
</ul>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script id="site-script" src="../../_/js/site.js" data-ui-root-path="../../_"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
<script src="../../_/js/vendor/lunr.js"></script>
<script src="../../_/js/search-ui.js" id="search-ui-script" data-site-root-path="../.." data-snippet-length="100" data-stylesheet="../../_/css/search.css"></script>
<script async src="../../search-index.js"></script>
  </body>
</html>
